# Coding Bus å¤šåŸŸåè®¤è¯ä¸æ”¯ä»˜ç³»ç»Ÿå®ç°è®¡åˆ’

## é¡¹ç›®æ¦‚è¿°

ä¸º Coding Bus å®ç°å®Œæ•´çš„å¤šåŸŸåè®¤è¯ï¼ˆå¾®ä¿¡+Googleï¼‰å’Œè·¨åŸŸæ”¯ä»˜ç³»ç»Ÿï¼Œæ”¯æŒå›½å†…å¤–ç”¨æˆ·çš„ç»Ÿä¸€è®¤è¯å’Œæ”¯ä»˜ä½“éªŒã€‚

---

## ğŸ¨ Stage 0: é¦–é¡µè½åœ°é¡µè®¾è®¡

### 0.1 æ•´ä½“è®¾è®¡ç†å¿µ

åŸºäº Claude Code å®˜æ–¹è½åœ°é¡µçš„è®¾è®¡é£æ ¼ï¼Œæ‰“é€ ä¸“ä¸šã€ç°ä»£ã€æ˜“ç”¨çš„ Coding Bus é¦–é¡µã€‚

**è®¾è®¡åŸåˆ™**ï¼š
- ğŸ¯ **æ¸…æ™°çš„ä»·å€¼ä¸»å¼ **ï¼šé¦–å±çªå‡ºæ ¸å¿ƒä»·å€¼ï¼ˆå¤šå¹³å°AIä¸­è½¬ã€ç»Ÿä¸€ç®¡ç†ï¼‰
- ğŸš€ **æ¸è¿›å¼å¼•å¯¼**ï¼šä»åŠŸèƒ½ä»‹ç» â†’ å¹³å°æ”¯æŒ â†’ å®šä»·æ–¹æ¡ˆ â†’ å¿«é€Ÿå¼€å§‹
- ğŸ’ **è§†è§‰ä¸€è‡´æ€§**ï¼šä¿æŒä¸åå°ç®¡ç†ç•Œé¢ä¸€è‡´çš„ç»ç’ƒæ€é£æ ¼å’Œæ¸å˜é…è‰²
- ğŸ“± **å“åº”å¼è®¾è®¡**ï¼šå®Œç¾é€‚é…æ¡Œé¢ã€å¹³æ¿ã€æ‰‹æœº
- ğŸŒ“ **æš—é»‘æ¨¡å¼å…¼å®¹**ï¼šæ‰€æœ‰ç»„ä»¶æ”¯æŒæ˜äº®/æš—é»‘åŒä¸»é¢˜

### 0.2 è½åœ°é¡µç»“æ„ï¼ˆ9ä¸ªSectionï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¯¼èˆªæ  (Navbar)                                  â”‚
â”‚    Logo + å¯¼èˆªèœå• + ç™»å½•/æ³¨å†ŒæŒ‰é’®                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. è‹±é›„åŒº (Hero Section)                           â”‚
â”‚    æ ‡é¢˜ + å‰¯æ ‡é¢˜ + CTAæŒ‰é’® + åŠ¨ç”»æ•ˆæœ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. æ ¸å¿ƒåŠŸèƒ½å±•ç¤º (Features)                          â”‚
â”‚    4å¤§æ ¸å¿ƒåŠŸèƒ½å¡ç‰‡ï¼ˆå¤šè´¦æˆ·ã€æ™ºèƒ½è°ƒåº¦ã€æˆæœ¬ä¼˜åŒ–ã€ç›‘æ§ï¼‰  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. æ”¯æŒçš„å¹³å° (Supported Platforms)                â”‚
â”‚    8å¤§å¹³å°å±•ç¤ºï¼ˆClaudeã€Geminiã€Bedrockç­‰ï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. å®šä»·æ–¹æ¡ˆ (Pricing)                              â”‚
â”‚    4ä¸ªå®šä»·å±‚çº§ï¼ˆå…è´¹ã€åŸºç¡€ã€ä¸“ä¸šã€ä¼ä¸šï¼‰               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. ä½¿ç”¨åœºæ™¯ (Use Cases)                            â”‚
â”‚    3å¤§åº”ç”¨åœºæ™¯ï¼ˆå¼€å‘è€…ã€å›¢é˜Ÿã€ä¼ä¸šï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7. å®¢æˆ·ç«¯æ¥å…¥æŒ‡å— (Client Integration)             â”‚
â”‚    å¿«é€Ÿæ¥å…¥æ­¥éª¤ + ä»£ç ç¤ºä¾‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 8. è¡ŒåŠ¨å·å¬ (CTA Section)                          â”‚
â”‚    ç«‹å³å¼€å§‹æŒ‰é’® + è”ç³»æ–¹å¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 9. é¡µè„š (Footer)                                   â”‚
â”‚    é“¾æ¥ã€æ–‡æ¡£ã€ç¤¾äº¤åª’ä½“ã€ç‰ˆæƒä¿¡æ¯                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 0.3 è¯¦ç»†è®¾è®¡è§„èŒƒ

#### 1. å¯¼èˆªæ ç»„ä»¶ (LandingNavbar.vue)

```vue
<template>
  <nav class="fixed top-0 left-0 right-0 z-50 backdrop-blur-lg bg-white/80 dark:bg-gray-900/80 border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-orange-500 to-red-600 flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
            </svg>
          </div>
          <span class="text-2xl font-bold bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">
            Coding Bus
          </span>
        </div>

        <!-- Desktop Navigation -->
        <div class="hidden md:flex items-center space-x-8">
          <a href="#features" class="text-gray-700 dark:text-gray-300 hover:text-orange-500 dark:hover:text-orange-400 transition-colors">
            åŠŸèƒ½ç‰¹æ€§
          </a>
          <a href="#platforms" class="text-gray-700 dark:text-gray-300 hover:text-orange-500 dark:hover:text-orange-400 transition-colors">
            æ”¯æŒå¹³å°
          </a>
          <a href="#pricing" class="text-gray-700 dark:text-gray-300 hover:text-orange-500 dark:hover:text-orange-400 transition-colors">
            å®šä»·æ–¹æ¡ˆ
          </a>
          <a href="#docs" class="text-gray-700 dark:text-gray-300 hover:text-orange-500 dark:hover:text-orange-400 transition-colors">
            æ–‡æ¡£
          </a>
        </div>

        <!-- Auth Buttons -->
        <div class="flex items-center space-x-4">
          <button
            @click="$router.push('/login')"
            class="hidden sm:block px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-orange-500 dark:hover:text-orange-400 transition-colors"
          >
            ç™»å½•
          </button>
          <button
            @click="$router.push('/register')"
            class="px-6 py-2 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg hover:from-orange-600 hover:to-red-700 transition-all shadow-lg hover:shadow-xl"
          >
            å…è´¹å¼€å§‹
          </button>
        </div>

        <!-- Mobile Menu Button -->
        <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden p-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div v-if="mobileMenuOpen" class="md:hidden border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
      <div class="px-4 py-6 space-y-4">
        <a href="#features" class="block text-gray-700 dark:text-gray-300 hover:text-orange-500">åŠŸèƒ½ç‰¹æ€§</a>
        <a href="#platforms" class="block text-gray-700 dark:text-gray-300 hover:text-orange-500">æ”¯æŒå¹³å°</a>
        <a href="#pricing" class="block text-gray-700 dark:text-gray-300 hover:text-orange-500">å®šä»·æ–¹æ¡ˆ</a>
        <a href="#docs" class="block text-gray-700 dark:text-gray-300 hover:text-orange-500">æ–‡æ¡£</a>
      </div>
    </div>
  </nav>
</template>

<script setup>
import { ref } from 'vue';
const mobileMenuOpen = ref(false);
</script>
```

#### 2. è‹±é›„åŒºç»„ä»¶ (HeroSection.vue)

```vue
<template>
  <section class="relative min-h-screen flex items-center justify-center overflow-hidden bg-gradient-to-b from-gray-50 to-white dark:from-gray-900 dark:to-gray-800">
    <!-- Animated Background -->
    <div class="absolute inset-0 overflow-hidden">
      <div class="absolute -top-40 -right-40 w-80 h-80 bg-orange-500/20 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-red-500/20 rounded-full blur-3xl animate-pulse delay-1000"></div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <!-- Title -->
      <h1 class="text-5xl sm:text-6xl lg:text-7xl font-bold mb-6">
        <span class="bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">
          å¤šå¹³å°AIä¸­è½¬æœåŠ¡
        </span>
      </h1>

      <!-- Subtitle -->
      <p class="text-xl sm:text-2xl text-gray-600 dark:text-gray-300 mb-8 max-w-3xl mx-auto">
        ç»Ÿä¸€ç®¡ç† Claudeã€Geminiã€Codex ç­‰ 8 å¤§å¹³å°è´¦æˆ·<br/>
        æ™ºèƒ½è°ƒåº¦ã€æˆæœ¬ä¼˜åŒ–ã€å®æ—¶ç›‘æ§ï¼Œè®© AI å¼€å‘æ›´ç®€å•
      </p>

      <!-- CTA Buttons -->
      <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-12">
        <button
          @click="$router.push('/register')"
          class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 text-white text-lg font-semibold rounded-lg hover:from-orange-600 hover:to-red-700 transition-all shadow-xl hover:shadow-2xl hover:scale-105"
        >
          å…è´¹å¼€å§‹ä½¿ç”¨
        </button>
        <button
          @click="scrollTo('#demo')"
          class="w-full sm:w-auto px-8 py-4 border-2 border-orange-500 text-orange-500 dark:text-orange-400 text-lg font-semibold rounded-lg hover:bg-orange-50 dark:hover:bg-gray-800 transition-all"
        >
          æŸ¥çœ‹æ¼”ç¤º
        </button>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-8 max-w-4xl mx-auto">
        <div class="text-center">
          <div class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">
            8+
          </div>
          <div class="text-gray-600 dark:text-gray-400 mt-2">æ”¯æŒå¹³å°</div>
        </div>
        <div class="text-center">
          <div class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">
            99.9%
          </div>
          <div class="text-gray-600 dark:text-gray-400 mt-2">æœåŠ¡å¯ç”¨æ€§</div>
        </div>
        <div class="text-center">
          <div class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">
            <500ms
          </div>
          <div class="text-gray-600 dark:text-gray-400 mt-2">å¹³å‡å“åº”</div>
        </div>
        <div class="text-center">
          <div class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">
            24/7
          </div>
          <div class="text-gray-600 dark:text-gray-400 mt-2">å…¨å¤©å€™æœåŠ¡</div>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
const scrollTo = (selector) => {
  document.querySelector(selector)?.scrollIntoView({ behavior: 'smooth' });
};
</script>
```

#### 3. æ ¸å¿ƒåŠŸèƒ½å±•ç¤º (FeaturesSection.vue)

```vue
<template>
  <section id="features" class="py-20 bg-white dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Section Title -->
      <div class="text-center mb-16">
        <h2 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
          æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§
        </h2>
        <p class="text-xl text-gray-600 dark:text-gray-300">
          ä¼ä¸šçº§ AI ä¸­è½¬æœåŠ¡ï¼ŒåŠ©åŠ›å¼€å‘è€…é«˜æ•ˆä½¿ç”¨å¤šå¹³å° AI èƒ½åŠ›
        </p>
      </div>

      <!-- Features Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
        <!-- Feature 1: Multi-Account -->
        <div class="group p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-orange-500 dark:hover:border-orange-500 transition-all hover:shadow-xl bg-white dark:bg-gray-800">
          <div class="w-14 h-14 rounded-lg bg-gradient-to-r from-orange-500 to-red-600 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
            å¤šè´¦æˆ·ç®¡ç†
          </h3>
          <p class="text-gray-600 dark:text-gray-400">
            æ”¯æŒ Claudeã€Geminiã€Codex ç­‰ 8 å¤§å¹³å°ï¼Œç»Ÿä¸€ç®¡ç†å¤šä¸ªè´¦æˆ·ï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡
          </p>
        </div>

        <!-- Feature 2: Smart Scheduling -->
        <div class="group p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-orange-500 dark:hover:border-orange-500 transition-all hover:shadow-xl bg-white dark:bg-gray-800">
          <div class="w-14 h-14 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
            æ™ºèƒ½è°ƒåº¦
          </h3>
          <p class="text-gray-600 dark:text-gray-400">
            ç²˜æ€§ä¼šè¯ã€å¹¶å‘æ§åˆ¶ã€è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œç¡®ä¿è¯·æ±‚é«˜æ•ˆå¯é å¤„ç†
          </p>
        </div>

        <!-- Feature 3: Cost Optimization -->
        <div class="group p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-orange-500 dark:hover:border-orange-500 transition-all hover:shadow-xl bg-white dark:bg-gray-800">
          <div class="w-14 h-14 rounded-lg bg-gradient-to-r from-green-500 to-teal-600 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
            æˆæœ¬ä¼˜åŒ–
          </h3>
          <p class="text-gray-600 dark:text-gray-400">
            å®æ—¶æˆæœ¬ç»Ÿè®¡ã€ç¼“å­˜ç›‘æ§ã€Token ä½¿ç”¨åˆ†æï¼Œå¸®åŠ©æ‚¨æ§åˆ¶ AI ä½¿ç”¨æˆæœ¬
          </p>
        </div>

        <!-- Feature 4: Real-time Monitoring -->
        <div class="group p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-orange-500 dark:hover:border-orange-500 transition-all hover:shadow-xl bg-white dark:bg-gray-800">
          <div class="w-14 h-14 rounded-lg bg-gradient-to-r from-pink-500 to-rose-600 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
            å®æ—¶ç›‘æ§
          </h3>
          <p class="text-gray-600 dark:text-gray-400">
            ç°ä»£åŒ–ç®¡ç†ç•Œé¢ï¼Œå®æ—¶æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ã€ä½¿ç”¨ç»Ÿè®¡å’Œè´¦æˆ·å¥åº·åº¦
          </p>
        </div>
      </div>
    </div>
  </section>
</template>
```

#### 4. æ”¯æŒçš„å¹³å°å±•ç¤º (PlatformsSection.vue)

```vue
<template>
  <section id="platforms" class="py-20 bg-gray-50 dark:bg-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <h2 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
          æ”¯æŒçš„ AI å¹³å°
        </h2>
        <p class="text-xl text-gray-600 dark:text-gray-300">
          ä¸€ä¸ªæœåŠ¡ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¸»æµ AI å¹³å°
        </p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <!-- Platform Card Template -->
        <div
          v-for="platform in platforms"
          :key="platform.name"
          class="group p-6 rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 hover:border-orange-500 dark:hover:border-orange-500 transition-all hover:shadow-lg text-center"
        >
          <div class="w-16 h-16 mx-auto mb-4 rounded-lg flex items-center justify-center" :class="platform.bgClass">
            <component :is="platform.icon" class="w-10 h-10 text-white"/>
          </div>
          <h3 class="font-semibold text-gray-900 dark:text-white mb-1">
            {{ platform.name }}
          </h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {{ platform.type }}
          </p>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { ref } from 'vue';

const platforms = ref([
  { name: 'Claude Official', type: 'Anthropic API', bgClass: 'bg-gradient-to-r from-orange-500 to-red-600' },
  { name: 'Claude Console', type: 'Console è´¦æˆ·', bgClass: 'bg-gradient-to-r from-orange-600 to-red-700' },
  { name: 'AWS Bedrock', type: 'AWS æœåŠ¡', bgClass: 'bg-gradient-to-r from-yellow-500 to-orange-600' },
  { name: 'Google Gemini', type: 'Google AI', bgClass: 'bg-gradient-to-r from-blue-500 to-purple-600' },
  { name: 'OpenAI Codex', type: 'Responses æ ¼å¼', bgClass: 'bg-gradient-to-r from-green-500 to-teal-600' },
  { name: 'Azure OpenAI', type: 'Azure æœåŠ¡', bgClass: 'bg-gradient-to-r from-blue-600 to-indigo-700' },
  { name: 'Droid (Factory.ai)', type: 'Factory AI', bgClass: 'bg-gradient-to-r from-purple-500 to-pink-600' },
  { name: 'CCR è´¦æˆ·', type: 'CCR å‡­æ®', bgClass: 'bg-gradient-to-r from-pink-500 to-rose-600' }
]);
</script>
```

#### 5. å®šä»·æ–¹æ¡ˆ (PricingSection.vue)

```vue
<template>
  <section id="pricing" class="py-20 bg-white dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <h2 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
          çµæ´»çš„å®šä»·æ–¹æ¡ˆ
        </h2>
        <p class="text-xl text-gray-600 dark:text-gray-300">
          ä»å…è´¹è¯•ç”¨åˆ°ä¼ä¸šå®šåˆ¶ï¼Œæ€»æœ‰é€‚åˆæ‚¨çš„æ–¹æ¡ˆ
        </p>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
        <!-- Free Tier -->
        <div class="p-8 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">å…è´¹ç‰ˆ</h3>
            <div class="text-4xl font-bold text-gray-900 dark:text-white">Â¥0</div>
            <div class="text-gray-500 dark:text-gray-400">æ°¸ä¹…å…è´¹</div>
          </div>
          <ul class="space-y-4 mb-8">
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">100 ä¸‡ tokens/æœˆ</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">1 ä¸ª API Key</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">åŸºç¡€åŠŸèƒ½</span>
            </li>
          </ul>
          <button class="w-full py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:border-orange-500 dark:hover:border-orange-500 transition-colors">
            å¼€å§‹ä½¿ç”¨
          </button>
        </div>

        <!-- Basic Tier -->
        <div class="p-8 rounded-xl border-2 border-orange-500 bg-white dark:bg-gray-800 relative">
          <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 px-4 py-1 bg-gradient-to-r from-orange-500 to-red-600 text-white text-sm font-semibold rounded-full">
            æ¨è
          </div>
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">åŸºç¡€ç‰ˆ</h3>
            <div class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">Â¥199</div>
            <div class="text-gray-500 dark:text-gray-400">/æœˆ</div>
          </div>
          <ul class="space-y-4 mb-8">
            <li class="flex items-start">
              <svg class="w-5 h-5 text-orange-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">500 ä¸‡ tokens/æœˆ</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-orange-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">5 ä¸ª API Keys</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-orange-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">æ‰€æœ‰å¹³å°æ”¯æŒ</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-orange-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">é‚®ä»¶æ”¯æŒ</span>
            </li>
          </ul>
          <button class="w-full py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg hover:from-orange-600 hover:to-red-700 transition-all shadow-lg">
            ç«‹å³è´­ä¹°
          </button>
        </div>

        <!-- Pro Tier -->
        <div class="p-8 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">ä¸“ä¸šç‰ˆ</h3>
            <div class="text-4xl font-bold text-gray-900 dark:text-white">Â¥499</div>
            <div class="text-gray-500 dark:text-gray-400">/æœˆ</div>
          </div>
          <ul class="space-y-4 mb-8">
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">2000 ä¸‡ tokens/æœˆ</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">æ— é™ API Keys</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">ä¼˜å…ˆæŠ€æœ¯æ”¯æŒ</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">Webhook é€šçŸ¥</span>
            </li>
          </ul>
          <button class="w-full py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:border-orange-500 dark:hover:border-orange-500 transition-colors">
            ç«‹å³è´­ä¹°
          </button>
        </div>

        <!-- Enterprise Tier -->
        <div class="p-8 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">ä¼ä¸šç‰ˆ</h3>
            <div class="text-4xl font-bold text-gray-900 dark:text-white">å®šåˆ¶</div>
            <div class="text-gray-500 dark:text-gray-400">è”ç³»æˆ‘ä»¬</div>
          </div>
          <ul class="space-y-4 mb-8">
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">æ— é™ tokens</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">ç§æœ‰åŒ–éƒ¨ç½²</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">SLA ä¿éšœ</span>
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-600 dark:text-gray-300">ä¸“å±æŠ€æœ¯é¡¾é—®</span>
            </li>
          </ul>
          <button class="w-full py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:border-orange-500 dark:hover:border-orange-500 transition-colors">
            è”ç³»é”€å”®
          </button>
        </div>
      </div>
    </div>
  </section>
</template>
```

### 0.4 è·¯ç”±é…ç½®

åœ¨ `web/admin-spa/src/router/index.js` ä¸­æ·»åŠ è½åœ°é¡µè·¯ç”±ï¼š

```javascript
{
  path: '/',
  name: 'landing',
  component: () => import('@/views/LandingPageView.vue'),
  meta: { layout: 'blank', requiresAuth: false }
}
```

### 0.5 å“åº”å¼è®¾è®¡è¦æ±‚

- **ç§»åŠ¨ç«¯ (< 640px)**ï¼šå•åˆ—å¸ƒå±€ï¼Œå¯¼èˆªæ æ±‰å ¡èœå•
- **å¹³æ¿ç«¯ (640px - 1024px)**ï¼š2åˆ—ç½‘æ ¼ï¼Œé€‚ä¸­å­—ä½“
- **æ¡Œé¢ç«¯ (> 1024px)**ï¼š4åˆ—ç½‘æ ¼ï¼Œå®Œæ•´å¯¼èˆª

### 0.6 æš—é»‘æ¨¡å¼é€‚é…

æ‰€æœ‰ç»„ä»¶å¿…é¡»åŒæ—¶æ”¯æŒæ˜äº®å’Œæš—é»‘æ¨¡å¼ï¼š
- èƒŒæ™¯ï¼š`bg-white dark:bg-gray-900`
- æ–‡æœ¬ï¼š`text-gray-900 dark:text-white`
- è¾¹æ¡†ï¼š`border-gray-200 dark:border-gray-700`
- æ¸å˜è‰²ä¿æŒä¸€è‡´ï¼ˆ`from-orange-500 to-red-600`ï¼‰

**Status**: Not Started

---

## ğŸŒ åŸŸåæ¶æ„è®¾è®¡

### åŸŸååˆ†é…ç­–ç•¥

| åŸŸå | ç”¨é€” | ICPå¤‡æ¡ˆ | ä¸»ä½“ç±»å‹ | æ”¯æŒçš„è®¤è¯æ–¹å¼ | æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ |
|------|------|---------|----------|---------------|---------------|
| **code.ai80.net** | ä¸»æœåŠ¡åŸŸåï¼ˆå›½å†…ï¼‰ | âœ… å·²å¤‡æ¡ˆ | ä¸ªäºº/ä¼ä¸š | å¾®ä¿¡ã€Googleã€LDAP | - |
| **vilicode.com** | å›½é™…æœåŠ¡åŸŸå | âŒ æœªå¤‡æ¡ˆ | - | Google | - |
| **code.ai80.vip** | ç»Ÿä¸€æ”¯ä»˜ç½‘å…³ | âœ… å·²å¤‡æ¡ˆ | ä¼ä¸š | - | æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ |

### æ¶æ„æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·è®¿é—®å±‚                                  â”‚
â”‚                                                                      â”‚
â”‚   code.ai80.net (å›½å†…)          vilicode.com (å›½é™…)                 â”‚
â”‚   æ”¯æŒ: å¾®ä¿¡+Google+LDAP         æ”¯æŒ: Google                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                            â”‚
               â”‚  OAuthè®¤è¯ï¼ˆè·¨åŸŸè·³è½¬ï¼‰       â”‚
               â”‚                            â”‚
               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
               â”‚            â”‚               â”‚
          å¾®ä¿¡ç™»å½•     Googleç™»å½•      LDAPç™»å½•
          (via vip)                 (æœ¬åœ°)
               â”‚            â”‚               â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    è·å– JWT Token
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                        â”‚
           ä½¿ç”¨æœåŠ¡              éœ€è¦ä»˜è´¹åŠŸèƒ½
                â”‚                        â”‚
                â”‚                        â†“
                â”‚            è·³è½¬åˆ° code.ai80.vip
                â”‚            (ç»Ÿä¸€æ”¯ä»˜ç½‘å…³)
                â”‚                        â”‚
                â”‚                 å®Œæˆæ”¯ä»˜
                â”‚                        â”‚
                â”‚            æ›´æ–°ç”¨æˆ·ä½™é¢/è®¢é˜…
                â”‚                        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **è®¤è¯åŸŸååˆ†ç¦»**: code.ai80.netå’Œvilicode.comä½œä¸ºç”¨æˆ·è®¿é—®åŸŸåï¼Œcode.ai80.vipä½œä¸ºOAuthè®¤è¯å’Œæ”¯ä»˜çš„ä¸­è½¬åŸŸå
2. **è·¨åŸŸå®‰å…¨**: é€šè¿‡HMAC-SHA256ç­¾åã€åŸŸåç™½åå•ã€æ—¶é—´é™åˆ¶tokenç¡®ä¿è·¨åŸŸå®‰å…¨
3. **ç”¨æˆ·æ— æ„ŸçŸ¥**: è·¨åŸŸè·³è½¬åœ¨1-2ç§’å†…å®Œæˆï¼Œç”¨æˆ·ä½“éªŒæµç•…
4. **ç»Ÿä¸€ä¼šè¯**: JWT Tokenåœ¨å„åŸŸåé—´é€šè¿‡URLå‚æ•°ä¼ é€’ï¼ŒlocalStorageç‹¬ç«‹å­˜å‚¨

---

## ğŸ“‹ Stage 1: å¤šåŸŸåè®¤è¯ç³»ç»Ÿ

### 1.1 å¾®ä¿¡ç™»å½•é›†æˆï¼ˆè·¨åŸŸæ–¹æ¡ˆï¼‰

#### ğŸ¯ ç›®æ ‡
åœ¨code.ai80.netï¼ˆä¸ªäººå¤‡æ¡ˆï¼‰å®ç°å¾®ä¿¡ç™»å½•ï¼Œé€šè¿‡code.ai80.vipï¼ˆä¼ä¸šå¤‡æ¡ˆï¼‰ä¸­è½¬

#### ğŸ“ å®Œæ•´ç™»å½•æµç¨‹

```
æ­¥éª¤1: ç”¨æˆ·åœ¨ code.ai80.net ç‚¹å‡»"å¾®ä¿¡ç™»å½•"
   â†“
æ­¥éª¤2: å‰ç«¯è·³è½¬åˆ° code.ai80.vip/auth/wechat/login?return_domain=code.ai80.net
   â†“
æ­¥éª¤3: code.ai80.vip ç”Ÿæˆå¾®ä¿¡æˆæƒURLï¼ˆå›è°ƒåŸŸåè®¾ç½®ä¸º code.ai80.vipï¼‰
   â†“
æ­¥éª¤4: é‡å®šå‘åˆ°å¾®ä¿¡æˆæƒé¡µé¢ï¼ˆæ‰«ç ï¼‰
   â†“
æ­¥éª¤5: ç”¨æˆ·å®Œæˆå¾®ä¿¡æ‰«ç æˆæƒ
   â†“
æ­¥éª¤6: å¾®ä¿¡å›è°ƒ code.ai80.vip/auth/wechat/callback?code=xxx&state=xxx
   â†“
æ­¥éª¤7: code.ai80.vip åç«¯äº¤æ¢ access_tokenï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
   â†“
æ­¥éª¤8: åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•ï¼ˆprovider='wechat'ï¼‰
   â†“
æ­¥éª¤9: ç”Ÿæˆ JWT Tokenï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
   â†“
æ­¥éª¤10: å›è·³åˆ° code.ai80.net/auth/callback?token=xxx&provider=wechat
   â†“
æ­¥éª¤11: code.ai80.net å‰ç«¯ä¿å­˜ token åˆ° localStorageï¼Œç™»å½•å®Œæˆ âœ…
```

#### ğŸ”§ å®ç°ç»†èŠ‚

##### 1. å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®

**å‰ç½®æ¡ä»¶**:
- ä¼ä¸šè¥ä¸šæ‰§ç…§
- ä¼ä¸šå¯¹å…¬è´¦æˆ·ï¼ˆç”¨äºæ‰“æ¬¾éªŒè¯ï¼‰
- ä¼ä¸šç®¡ç†å‘˜èº«ä»½è¯æ˜
- è®¤è¯è´¹ç”¨ï¼š300å…ƒ/å¹´

**ç”³è¯·æ­¥éª¤**:
1. è®¿é—® https://open.weixin.qq.com/
2. ä½¿ç”¨ä¼ä¸šèµ„è´¨æ³¨å†Œå¼€å‘è€…è´¦å·
3. æäº¤ä¼ä¸šè®¤è¯ï¼ˆ1-3ä¸ªå·¥ä½œæ—¥ï¼‰
4. åˆ›å»º"ç½‘ç«™åº”ç”¨"
5. **æˆæƒå›è°ƒåŸŸå**: å¡«å†™ `code.ai80.vip`ï¼ˆä¸åŒ…å«åè®®å’Œè·¯å¾„ï¼‰
6. ç­‰å¾…å®¡æ ¸ï¼ˆ1-3ä¸ªå·¥ä½œæ—¥ï¼‰
7. è·å¾— AppID å’Œ AppSecret

##### 2. åç«¯æœåŠ¡å®ç°

**åˆ›å»ºæ–‡ä»¶**:
```bash
touch src/services/wechatAuthService.js
touch src/routes/userAuthRoutes.js
```

**wechatAuthService.js** - å¾®ä¿¡è®¤è¯æœåŠ¡

```javascript
// src/services/wechatAuthService.js
const axios = require('axios');
const crypto = require('crypto');
const redis = require('../models/redis');
const logger = require('../utils/logger');

class WechatAuthService {
  constructor() {
    this.appId = process.env.WECHAT_APP_ID;
    this.appSecret = process.env.WECHAT_APP_SECRET;
    this.redirectUri = process.env.WECHAT_REDIRECT_URI;
    this.encryptionKey = Buffer.from(process.env.ENCRYPTION_KEY, 'utf8');
  }

  /**
   * ç”Ÿæˆå¾®ä¿¡æˆæƒURL
   * @param {string} state - åŒ…å«è¿”å›åŸŸåçš„stateå‚æ•°
   */
  generateAuthUrl(state) {
    const params = new URLSearchParams({
      appid: this.appId,
      redirect_uri: encodeURIComponent(this.redirectUri),
      response_type: 'code',
      scope: 'snsapi_login', // ç½‘ç«™åº”ç”¨ä½¿ç”¨ snsapi_login
      state: state
    });

    return `https://open.weixin.qq.com/connect/qrconnect?${params.toString()}#wechat_redirect`;
  }

  /**
   * ä½¿ç”¨codeäº¤æ¢access_token
   * @param {string} code - å¾®ä¿¡è¿”å›çš„æˆæƒç 
   */
  async exchangeCodeForToken(code) {
    try {
      const url = 'https://api.weixin.qq.com/sns/oauth2/access_token';
      const params = {
        appid: this.appId,
        secret: this.appSecret,
        code: code,
        grant_type: 'authorization_code'
      };

      const response = await axios.get(url, { params, timeout: 10000 });

      if (response.data.errcode) {
        throw new Error(`å¾®ä¿¡tokenäº¤æ¢å¤±è´¥: ${response.data.errmsg}`);
      }

      return {
        accessToken: response.data.access_token,
        refreshToken: response.data.refresh_token,
        openid: response.data.openid,
        unionid: response.data.unionid,
        expiresIn: response.data.expires_in
      };
    } catch (error) {
      logger.error('å¾®ä¿¡tokenäº¤æ¢å¤±è´¥', { error: error.message, code });
      throw error;
    }
  }

  /**
   * è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
   * @param {string} accessToken
   * @param {string} openid
   */
  async getUserInfo(accessToken, openid) {
    try {
      const url = 'https://api.weixin.qq.com/sns/userinfo';
      const params = {
        access_token: accessToken,
        openid: openid
      };

      const response = await axios.get(url, { params, timeout: 10000 });

      if (response.data.errcode) {
        throw new Error(`è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${response.data.errmsg}`);
      }

      return {
        openid: response.data.openid,
        unionid: response.data.unionid,
        nickname: response.data.nickname,
        avatar: response.data.headimgurl,
        sex: response.data.sex,
        province: response.data.province,
        city: response.data.city,
        country: response.data.country
      };
    } catch (error) {
      logger.error('è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯å¤±è´¥', { error: error.message, openid });
      throw error;
    }
  }

  /**
   * åˆ·æ–°access_token
   * @param {string} refreshToken
   */
  async refreshAccessToken(refreshToken) {
    const url = 'https://api.weixin.qq.com/sns/oauth2/refresh_token';
    const params = {
      appid: this.appId,
      grant_type: 'refresh_token',
      refresh_token: refreshToken
    };

    const response = await axios.get(url, { params });

    if (response.data.errcode) {
      throw new Error(`åˆ·æ–°tokenå¤±è´¥: ${response.data.errmsg}`);
    }

    return {
      accessToken: response.data.access_token,
      refreshToken: response.data.refresh_token,
      expiresIn: response.data.expires_in
    };
  }

  /**
   * åŠ å¯†å­˜å‚¨token
   */
  encryptToken(tokenData) {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv('aes-256-cbc', this.encryptionKey, iv);

    let encrypted = cipher.update(JSON.stringify(tokenData), 'utf8', 'hex');
    encrypted += cipher.final('hex');

    return iv.toString('hex') + ':' + encrypted;
  }

  /**
   * è§£å¯†token
   */
  decryptToken(encryptedData) {
    const parts = encryptedData.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const encrypted = parts[1];

    const decipher = crypto.createDecipheriv('aes-256-cbc', this.encryptionKey, iv);

    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');

    return JSON.parse(decrypted);
  }

  /**
   * åˆ›å»ºæˆ–æ›´æ–°å¾®ä¿¡ç”¨æˆ·
   */
  async createOrUpdateUser(wechatUser, tokenInfo) {
    const userService = require('./userService');

    // æŸ¥æ‰¾å·²å­˜åœ¨çš„ç”¨æˆ·ï¼ˆé€šè¿‡unionidæˆ–openidï¼‰
    let user = await userService.getUserByWechatId(wechatUser.unionid || wechatUser.openid);

    const userData = {
      provider: 'wechat',
      wechatOpenid: wechatUser.openid,
      wechatUnionid: wechatUser.unionid,
      name: wechatUser.nickname,
      avatar: wechatUser.avatar,
      lastLoginAt: new Date().toISOString()
    };

    if (!user) {
      // åˆ›å»ºæ–°ç”¨æˆ·
      user = await userService.createUser({
        username: `wechat_${wechatUser.openid.substring(0, 10)}`,
        ...userData
      });
    } else {
      // æ›´æ–°ç°æœ‰ç”¨æˆ·
      user = await userService.updateUser(user.id, userData);
    }

    // åŠ å¯†å¹¶å­˜å‚¨å¾®ä¿¡token
    const encryptedToken = this.encryptToken(tokenInfo);
    await redis.setex(
      `user:${user.id}:wechat_token`,
      tokenInfo.expiresIn,
      encryptedToken
    );

    return user;
  }
}

module.exports = new WechatAuthService();
```

**userAuthRoutes.js** - è®¤è¯è·¯ç”±

```javascript
// src/routes/userAuthRoutes.js
const express = require('express');
const router = express.Router();
const crypto = require('crypto');
const jwt = require('jsonwebtoken');
const wechatAuthService = require('../services/wechatAuthService');
const googleAuthService = require('../services/googleAuthService');
const logger = require('../utils/logger');

/**
 * ç”Ÿæˆstateå‚æ•°ï¼ˆåŒ…å«åŸå§‹åŸŸåã€éšæœºå­—ç¬¦ä¸²ã€æ—¶é—´æˆ³ï¼‰
 */
function generateState(originalDomain) {
  const stateData = {
    random: crypto.randomBytes(16).toString('hex'),
    returnDomain: originalDomain,
    timestamp: Date.now()
  };
  return Buffer.from(JSON.stringify(stateData)).toString('base64');
}

/**
 * éªŒè¯stateå‚æ•°
 */
function verifyState(state) {
  try {
    const decoded = JSON.parse(Buffer.from(state, 'base64').toString('utf-8'));

    // æ£€æŸ¥stateæ˜¯å¦åœ¨5åˆ†é’Ÿå†…æœ‰æ•ˆ
    if (Date.now() - decoded.timestamp > 5 * 60 * 1000) {
      return null;
    }

    // éªŒè¯å›è·³åŸŸååœ¨ç™½åå•ä¸­
    const allowedDomains = process.env.ALLOWED_AUTH_RETURN_DOMAINS.split(',');
    if (!allowedDomains.some(d => decoded.returnDomain.includes(d))) {
      logger.warn('å›è·³åŸŸåä¸åœ¨ç™½åå•ä¸­', { domain: decoded.returnDomain });
      return null;
    }

    return decoded;
  } catch (error) {
    logger.error('stateéªŒè¯å¤±è´¥', { error: error.message });
    return null;
  }
}

/**
 * ç”ŸæˆJWT Token
 */
function generateJWT(user) {
  return jwt.sign(
    {
      userId: user.id,
      provider: user.provider,
      email: user.email,
      name: user.name || user.nickname,
      avatar: user.avatar
    },
    process.env.JWT_SECRET,
    { expiresIn: '30d' }
  );
}

// ==================== å¾®ä¿¡ç™»å½• ====================

/**
 * å¾®ä¿¡ç™»å½•å…¥å£ï¼ˆè·¨åŸŸè·³è½¬ï¼‰
 * GET /auth/wechat/login?return_domain=code.ai80.net
 */
router.get('/wechat/login', (req, res) => {
  try {
    const returnDomain = req.query.return_domain || req.get('referer');

    if (!returnDomain) {
      return res.status(400).json({ error: 'ç¼ºå°‘è¿”å›åŸŸåå‚æ•°' });
    }

    // ç”ŸæˆåŒ…å«åŸå§‹åŸŸåçš„state
    const state = generateState(returnDomain);

    // ç”Ÿæˆå¾®ä¿¡æˆæƒURLï¼ˆå›è°ƒåŸŸåæ˜¯ code.ai80.vipï¼‰
    const authUrl = wechatAuthService.generateAuthUrl(state);

    logger.info('ç”Ÿæˆå¾®ä¿¡æˆæƒURL', { returnDomain, authUrl });

    // é‡å®šå‘åˆ°å¾®ä¿¡æˆæƒé¡µé¢
    res.redirect(authUrl);
  } catch (error) {
    logger.error('ç”Ÿæˆå¾®ä¿¡ç™»å½•URLå¤±è´¥', { error: error.message });
    res.status(500).json({ error: 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
  }
});

/**
 * å¾®ä¿¡ç™»å½•å›è°ƒï¼ˆå¾®ä¿¡å›è°ƒåˆ° code.ai80.vipï¼‰
 * GET /auth/wechat/callback?code=xxx&state=xxx
 */
router.get('/wechat/callback', async (req, res) => {
  try {
    const { code, state } = req.query;

    if (!code || !state) {
      throw new Error('ç¼ºå°‘å¿…è¦å‚æ•°');
    }

    // éªŒè¯state
    const stateData = verifyState(state);
    if (!stateData) {
      throw new Error('æ— æ•ˆçš„stateå‚æ•°æˆ–å›è·³åŸŸå');
    }

    // 1. ä½¿ç”¨codeäº¤æ¢access_token
    const tokenInfo = await wechatAuthService.exchangeCodeForToken(code);

    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    const wechatUser = await wechatAuthService.getUserInfo(
      tokenInfo.accessToken,
      tokenInfo.openid
    );

    // 3. åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
    const user = await wechatAuthService.createOrUpdateUser(wechatUser, tokenInfo);

    // 4. ç”ŸæˆJWT
    const jwtToken = generateJWT(user);

    // 5. å›è·³åˆ°åŸå§‹åŸŸå
    const returnUrl = `https://${stateData.returnDomain}/auth/callback?token=${jwtToken}&provider=wechat`;

    logger.info('å¾®ä¿¡ç™»å½•æˆåŠŸï¼Œå›è·³åˆ°', {
      userId: user.id,
      returnDomain: stateData.returnDomain
    });

    res.redirect(returnUrl);

  } catch (error) {
    logger.error('å¾®ä¿¡ç™»å½•å›è°ƒå¤±è´¥', { error: error.message, stack: error.stack });

    // å›è·³åˆ°é”™è¯¯é¡µé¢
    const stateData = req.query.state ? verifyState(req.query.state) : null;
    const returnDomain = stateData?.returnDomain || 'code.ai80.net';
    const errorUrl = `https://${returnDomain}/auth/error?message=${encodeURIComponent(error.message)}&provider=wechat`;

    res.redirect(errorUrl);
  }
});

// ==================== Googleç™»å½• ====================

/**
 * Googleç™»å½•ï¼ˆä½¿ç”¨GIS ID TokenéªŒè¯ï¼‰
 * POST /auth/google/login
 * Body: { credential: "google_id_token", nonce: "optional_nonce" }
 */
router.post('/google/login', async (req, res) => {
  try {
    const { credential, nonce } = req.body;

    if (!credential) {
      return res.status(400).json({ error: 'ç¼ºå°‘Google credential' });
    }

    // 1. éªŒè¯Google ID Token
    const payload = await googleAuthService.verifyIdToken(credential, nonce);

    // 2. éªŒè¯emailå¿…é¡»å·²éªŒè¯
    if (!payload.email_verified) {
      return res.status(400).json({ error: 'é‚®ç®±æœªéªŒè¯ï¼Œè¯·ä½¿ç”¨å·²éªŒè¯çš„Googleè´¦å·' });
    }

    // 3. æ£€æŸ¥åŸŸåç™½åå•ï¼ˆå¯é€‰ï¼‰
    if (process.env.GOOGLE_OAUTH_ALLOWED_DOMAINS) {
      const allowedDomains = process.env.GOOGLE_OAUTH_ALLOWED_DOMAINS.split(',');
      const emailDomain = payload.email.split('@')[1];

      if (!allowedDomains.includes(emailDomain)) {
        return res.status(403).json({
          error: `ä¸å…è®¸çš„é‚®ç®±åŸŸåã€‚ä»…æ”¯æŒ: ${allowedDomains.join(', ')}`
        });
      }
    }

    // 4. åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
    const user = await googleAuthService.createOrUpdateUser(payload);

    // 5. ç”ŸæˆJWT
    const jwtToken = generateJWT(user);

    // 6. åˆ›å»ºRedisä¼šè¯ï¼ˆä¸ç°æœ‰ç³»ç»Ÿå…¼å®¹ï¼‰
    const userService = require('../services/userService');
    const sessionToken = await userService.createUserSession(user.id);

    logger.info('Googleç™»å½•æˆåŠŸ', {
      userId: user.id,
      email: payload.email,
      provider: 'google'
    });

    res.json({
      success: true,
      token: jwtToken,
      sessionToken: sessionToken, // å…¼å®¹ç°æœ‰ä¼šè¯ç³»ç»Ÿ
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        avatar: user.avatar,
        provider: 'google'
      }
    });

  } catch (error) {
    logger.error('Googleç™»å½•å¤±è´¥', { error: error.message, stack: error.stack });

    res.status(401).json({
      error: error.message || 'Googleç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    });
  }
});

/**
 * è·å–è®¤è¯é…ç½®
 * GET /auth/config
 */
router.get('/config', (req, res) => {
  res.json({
    wechatEnabled: !!process.env.WECHAT_APP_ID,
    googleEnabled: process.env.GOOGLE_OAUTH_ENABLE === 'true',
    ldapEnabled: process.env.LDAP_ENABLED === 'true',
    allowedDomains: {
      google: process.env.GOOGLE_OAUTH_ALLOWED_DOMAINS?.split(',') || []
    }
  });
});

/**
 * é€šç”¨ç™»å‡º
 * POST /auth/logout
 */
router.post('/logout', async (req, res) => {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');

    if (token) {
      // å°†tokenåŠ å…¥é»‘åå•ï¼ˆ15åˆ†é’ŸTTLï¼Œè¶³å¤ŸJWTéªŒè¯å¤±è´¥ï¼‰
      const redis = require('../models/redis');
      await redis.setex(`token:blacklist:${token}`, 900, '1');
    }

    res.json({ success: true, message: 'ç™»å‡ºæˆåŠŸ' });
  } catch (error) {
    logger.error('ç™»å‡ºå¤±è´¥', { error: error.message });
    res.status(500).json({ error: 'ç™»å‡ºå¤±è´¥' });
  }
});

module.exports = router;
```

##### 3. Googleè®¤è¯æœåŠ¡å®ç°

**åˆ›å»ºæ–‡ä»¶**:
```bash
touch src/services/googleAuthService.js
```

**googleAuthService.js** - Google GISè®¤è¯

```javascript
// src/services/googleAuthService.js
const { OAuth2Client } = require('google-auth-library');
const redis = require('../models/redis');
const logger = require('../utils/logger');

class GoogleAuthService {
  constructor() {
    this.clientId = process.env.GOOGLE_CLIENT_ID;
    this.client = new OAuth2Client(this.clientId);
  }

  /**
   * éªŒè¯Google ID Token
   * @param {string} idToken - Googleè¿”å›çš„ID token
   * @param {string} nonce - å¯é€‰çš„nonceå‚æ•°ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
   */
  async verifyIdToken(idToken, nonce = null) {
    try {
      // å¦‚æœæä¾›äº†nonceï¼Œæ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨è¿‡
      if (nonce) {
        const nonceKey = `oauth_nonce:${nonce}`;
        const exists = await redis.get(nonceKey);

        if (exists) {
          throw new Error('Nonceå·²è¢«ä½¿ç”¨ï¼Œå¯èƒ½æ˜¯é‡æ”¾æ”»å‡»');
        }

        // æ ‡è®°nonceä¸ºå·²ä½¿ç”¨ï¼ˆ5åˆ†é’ŸTTLï¼‰
        await redis.setex(nonceKey, 300, '1');
      }

      const ticket = await this.client.verifyIdToken({
        idToken: idToken,
        audience: this.clientId
      });

      const payload = ticket.getPayload();

      // éªŒè¯issuer
      if (payload.iss !== 'https://accounts.google.com' && payload.iss !== 'accounts.google.com') {
        throw new Error('æ— æ•ˆçš„token issuer');
      }

      // éªŒè¯audience
      if (payload.aud !== this.clientId) {
        throw new Error('æ— æ•ˆçš„token audience');
      }

      // éªŒè¯è¿‡æœŸæ—¶é—´
      if (payload.exp * 1000 < Date.now()) {
        throw new Error('Tokenå·²è¿‡æœŸ');
      }

      logger.info('Google ID TokenéªŒè¯æˆåŠŸ', {
        sub: payload.sub,
        email: payload.email
      });

      return payload;

    } catch (error) {
      logger.error('Google ID TokenéªŒè¯å¤±è´¥', {
        error: error.message,
        category: this.categorizeError(error)
      });
      throw error;
    }
  }

  /**
   * é”™è¯¯åˆ†ç±»ï¼ˆç”¨äºç›‘æ§å’Œå‘Šè­¦ï¼‰
   */
  categorizeError(error) {
    const message = error.message.toLowerCase();

    if (message.includes('audience')) return 'invalid_audience';
    if (message.includes('expired')) return 'expired_token';
    if (message.includes('issuer')) return 'invalid_issuer';
    if (message.includes('nonce')) return 'replay_attempt';
    if (message.includes('domain')) return 'blocked_domain';

    return 'verification_failed';
  }

  /**
   * æå–å’Œæ ‡å‡†åŒ–Googleç”¨æˆ·ä¿¡æ¯
   */
  mapGoogleProfile(payload) {
    return {
      googleSub: payload.sub,
      email: payload.email,
      emailVerified: payload.email_verified,
      name: payload.name,
      givenName: payload.given_name,
      familyName: payload.family_name,
      avatar: payload.picture,
      locale: payload.locale
    };
  }

  /**
   * åˆ›å»ºæˆ–æ›´æ–°Googleç”¨æˆ·
   */
  async createOrUpdateUser(payload) {
    const userService = require('./userService');

    const profile = this.mapGoogleProfile(payload);

    // é€šè¿‡googleSubæŸ¥æ‰¾ç”¨æˆ·
    let user = await userService.getUserByGoogleSub(profile.googleSub);

    const userData = {
      provider: 'google',
      googleSub: profile.googleSub,
      email: profile.email,
      name: profile.name,
      avatar: profile.avatar,
      lastLoginAt: new Date().toISOString()
    };

    if (!user) {
      // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²è¢«å…¶ä»–providerä½¿ç”¨
      const existingUser = await userService.getUserByEmail(profile.email);

      if (existingUser && existingUser.provider !== 'google') {
        throw new Error(
          `è¯¥é‚®ç®±å·²å…³è”${existingUser.provider}è´¦å·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åˆå¹¶è´¦æˆ·`
        );
      }

      // åˆ›å»ºæ–°ç”¨æˆ·
      user = await userService.createUser({
        username: profile.email.split('@')[0],
        ...userData
      });
    } else {
      // æ›´æ–°ç°æœ‰ç”¨æˆ·
      user = await userService.updateUser(user.id, userData);
    }

    return user;
  }
}

module.exports = new GoogleAuthService();
```

##### 4. æ‰©å±•userServiceæ”¯æŒOAuth

åœ¨ç°æœ‰çš„ `src/services/userService.js` ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

```javascript
// src/services/userService.js æ·»åŠ 

/**
 * é€šè¿‡å¾®ä¿¡IDæŸ¥æ‰¾ç”¨æˆ·
 */
async getUserByWechatId(wechatId) {
  const users = await this.getAllUsers();
  return users.find(u =>
    u.wechatUnionid === wechatId || u.wechatOpenid === wechatId
  );
}

/**
 * é€šè¿‡GoogleSubæŸ¥æ‰¾ç”¨æˆ·
 */
async getUserByGoogleSub(googleSub) {
  const users = await this.getAllUsers();
  return users.find(u => u.googleSub === googleSub);
}

/**
 * é€šè¿‡é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
 */
async getUserByEmail(email) {
  const users = await this.getAllUsers();
  return users.find(u => u.email === email);
}
```

##### 5. å‰ç«¯å®ç° - å¾®ä¿¡ç™»å½•

**ç™»å½•æŒ‰é’®ç»„ä»¶** (`web/admin-spa/src/components/auth/WechatLoginButton.vue`)

```vue
<template>
  <button
    @click="handleWechatLogin"
    :disabled="isLoading"
    class="flex items-center justify-center w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
  >
    <svg v-if="!isLoading" class="w-5 h-5 mr-2" fill="#07C160" viewBox="0 0 24 24">
      <!-- å¾®ä¿¡å›¾æ ‡SVG -->
      <path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-5.523 2.804-7.192C14.691 8.088 16.723 7.2 18.95 7.2c.87 0 1.714.11 2.523.315-.752-3.146-4.793-5.327-9.782-5.327zM6.196 7.12a.93.93 0 1 1 .002-1.86.93.93 0 0 1-.002 1.86zm5.012 0a.93.93 0 1 1 .002-1.86.93.93 0 0 1-.002 1.86z"/>
      <path d="M16.95 8.99c-4.508 0-8.076 2.753-8.076 6.155 0 1.984 1.049 3.768 2.691 4.972a.528.528 0 0 1 .19.592l-.348 1.323a1.19 1.19 0 0 0-.043.19c0 .146.116.264.259.264.067 0 .131-.02.189-.048l1.703-.997a.774.774 0 0 1 .641-.088c.67.188 1.383.294 2.118.294 4.508 0 8.076-2.753 8.076-6.155 0-3.401-3.568-6.502-8.076-6.502zm-1.546 7.772a.833.833 0 1 1 0-1.666.833.833 0 0 1 0 1.666zm3.68 0a.833.833 0 1 1 .001-1.667.833.833 0 0 1 0 1.667z"/>
    </svg>
    <svg v-else class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span>{{ isLoading ? 'æ­£åœ¨è·³è½¬...' : 'å¾®ä¿¡ç™»å½•' }}</span>
  </button>

  <!-- åŠ è½½æç¤ºå¼¹çª— -->
  <div v-if="isLoading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 text-center">
      <svg class="animate-spin h-10 w-10 mx-auto mb-4 text-green-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-900 dark:text-white">æ­£åœ¨è·³è½¬åˆ°å¾®ä¿¡ç™»å½•...</p>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">è¯·ç¨å€™</p>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';

const isLoading = ref(false);

const handleWechatLogin = () => {
  isLoading.value = true;

  // è·å–å½“å‰åŸŸå
  const returnDomain = window.location.hostname;

  // è·³è½¬åˆ° code.ai80.vip çš„å¾®ä¿¡ç™»å½•å…¥å£
  const loginUrl = `https://code.ai80.vip/auth/wechat/login?return_domain=${returnDomain}`;

  // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼ˆ30ç§’ï¼‰
  const timeout = setTimeout(() => {
    if (isLoading.value) {
      isLoading.value = false;
      alert('ç™»å½•è¶…æ—¶ï¼Œè¯·é‡è¯•');
    }
  }, 30000);

  // è·³è½¬
  window.location.href = loginUrl;
};
</script>
```

**ç™»å½•å›è°ƒå¤„ç†** (`web/admin-spa/src/views/auth/AuthCallbackView.vue`)

```vue
<template>
  <div class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
    <div class="text-center">
      <svg class="animate-spin h-12 w-12 mx-auto mb-4 text-orange-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-xl text-gray-900 dark:text-white">æ­£åœ¨å®Œæˆç™»å½•...</p>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">{{ statusMessage }}</p>
    </div>
  </div>
</template>

<script setup>
import { onMounted, ref } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { useAuthStore } from '@/stores/auth';

const router = useRouter();
const route = useRoute();
const authStore = useAuthStore();
const statusMessage = ref('éªŒè¯ç™»å½•å‡­æ®...');

onMounted(async () => {
  try {
    const { token, provider } = route.query;

    if (!token) {
      throw new Error('ç¼ºå°‘ç™»å½•å‡­æ®');
    }

    statusMessage.value = 'ä¿å­˜ç™»å½•çŠ¶æ€...';

    // ä¿å­˜JWTåˆ°localStorage
    localStorage.setItem('auth_token', token);
    localStorage.setItem('auth_provider', provider);

    // æ›´æ–°Pinia store
    authStore.token = token;
    authStore.isAuthenticated = true;

    statusMessage.value = 'è·å–ç”¨æˆ·ä¿¡æ¯...';

    // è·å–ç”¨æˆ·ä¿¡æ¯
    await authStore.fetchUserInfo();

    statusMessage.value = 'ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...';

    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
    setTimeout(() => {
      router.push('/dashboard');
    }, 500);

  } catch (error) {
    console.error('ç™»å½•å›è°ƒå¤„ç†å¤±è´¥:', error);
    alert(`ç™»å½•å¤±è´¥: ${error.message}`);
    router.push('/login');
  }
});
</script>
```

**é”™è¯¯é¡µé¢** (`web/admin-spa/src/views/auth/AuthErrorView.vue`)

```vue
<template>
  <div class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
    <div class="max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 text-center">
      <svg class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>

      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
        ç™»å½•å¤±è´¥
      </h2>

      <p class="text-gray-600 dark:text-gray-300 mb-6">
        {{ errorMessage }}
      </p>

      <div class="space-y-3">
        <button
          @click="retryLogin"
          class="w-full px-4 py-2 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg hover:from-orange-600 hover:to-red-700 transition-all"
        >
          é‡æ–°ç™»å½•
        </button>

        <button
          @click="goHome"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
        >
          è¿”å›é¦–é¡µ
        </button>
      </div>

      <div class="mt-6 text-sm text-gray-500 dark:text-gray-400">
        <p>å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»å®¢æœ</p>
        <p class="mt-1">é”™è¯¯ä»£ç : {{ provider }}_auth_failed</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRouter, useRoute } from 'vue-router';

const router = useRouter();
const route = useRoute();

const errorMessage = ref('æœªçŸ¥é”™è¯¯');
const provider = ref('unknown');

onMounted(() => {
  errorMessage.value = decodeURIComponent(route.query.message || 'ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
  provider.value = route.query.provider || 'unknown';
});

const retryLogin = () => {
  router.push('/login');
};

const goHome = () => {
  router.push('/');
};
</script>
```

##### 6. Googleç™»å½•å‰ç«¯å®ç°

**Googleç™»å½•æŒ‰é’®ç»„ä»¶** (`web/admin-spa/src/components/auth/GoogleLoginButton.vue`)

```vue
<template>
  <div>
    <!-- GoogleæŒ‰é’®å®¹å™¨ -->
    <div
      id="google-signin-button"
      class="w-full flex items-center justify-center"
    ></div>

    <!-- å¤‡ç”¨æŒ‰é’®ï¼ˆGISåŠ è½½å¤±è´¥æ—¶ï¼‰ -->
    <button
      v-if="showFallback"
      @click="handleManualLogin"
      class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
    >
      <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      <span>ä½¿ç”¨Googleç™»å½•</span>
    </button>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useAuthStore } from '@/stores/auth';
import axios from 'axios';

const router = useRouter();
const authStore = useAuthStore();
const showFallback = ref(false);

// ç”Ÿæˆnonceï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
const generateNonce = () => {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
};

const handleGoogleCallback = async (response) => {
  try {
    const nonce = sessionStorage.getItem('google_auth_nonce');

    // å‘é€ID tokenåˆ°åç«¯éªŒè¯
    const result = await axios.post('/auth/google/login', {
      credential: response.credential,
      nonce: nonce
    });

    // ä¿å­˜token
    authStore.setAuth(result.data);

    // æ¸…é™¤nonce
    sessionStorage.removeItem('google_auth_nonce');

    // è·³è½¬åˆ°æ§åˆ¶å°
    router.push('/dashboard');

  } catch (error) {
    console.error('Googleç™»å½•å¤±è´¥:', error);
    alert(error.response?.data?.error || 'Googleç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
};

onMounted(() => {
  // åŠ¨æ€åŠ è½½Google Identity Servicesè„šæœ¬
  const script = document.createElement('script');
  script.src = 'https://accounts.google.com/gsi/client';
  script.async = true;
  script.defer = true;

  script.onload = () => {
    // åˆå§‹åŒ–Google Identity Services
    window.google.accounts.id.initialize({
      client_id: import.meta.env.VITE_GOOGLE_CLIENT_ID,
      callback: handleGoogleCallback,
      nonce: generateNonce(),
      auto_select: false,
      cancel_on_tap_outside: true
    });

    // ç”Ÿæˆå¹¶ä¿å­˜nonce
    const nonce = generateNonce();
    sessionStorage.setItem('google_auth_nonce', nonce);

    // æ¸²æŸ“GoogleæŒ‰é’®
    window.google.accounts.id.renderButton(
      document.getElementById('google-signin-button'),
      {
        theme: 'outline',
        size: 'large',
        width: '100%',
        text: 'signin_with',
        shape: 'rectangular',
        logo_alignment: 'left'
      }
    );

    // å¯é€‰ï¼šæ˜¾ç¤ºOne Tapæç¤º
    // window.google.accounts.id.prompt();
  };

  script.onerror = () => {
    console.error('Google Identity ServicesåŠ è½½å¤±è´¥');
    showFallback.value = true;
  };

  document.head.appendChild(script);
});

const handleManualLogin = () => {
  alert('Googleç™»å½•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•æˆ–ä½¿ç”¨å…¶ä»–ç™»å½•æ–¹å¼');
};
</script>
```

##### 7. è·¯ç”±é…ç½®

æ›´æ–° `web/admin-spa/src/router/index.js`ï¼š

```javascript
// æ·»åŠ è®¤è¯è·¯ç”±
{
  path: '/auth/callback',
  name: 'auth-callback',
  component: () => import('@/views/auth/AuthCallbackView.vue'),
  meta: { layout: 'blank' }
},
{
  path: '/auth/error',
  name: 'auth-error',
  component: () => import('@/views/auth/AuthErrorView.vue'),
  meta: { layout: 'blank' }
}
```

##### 8. Pinia Auth Storeæ›´æ–°

æ‰©å±• `web/admin-spa/src/stores/auth.js`ï¼š

```javascript
// stores/auth.js æ·»åŠ 
async fetchUserInfo() {
  try {
    const response = await axios.get('/auth/me', {
      headers: {
        Authorization: `Bearer ${this.token}`
      }
    });

    this.user = response.data.user;
    this.isAuthenticated = true;

    localStorage.setItem('user_info', JSON.stringify(response.data.user));
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    this.clearAuth();
    throw error;
  }
}
```

---

### æµ‹è¯•æ¸…å•

#### å¾®ä¿¡ç™»å½•æµ‹è¯•
- [ ] code.ai80.net â†’ å¾®ä¿¡ç™»å½• â†’ æ‰«ç æˆæƒ â†’ å›è·³æˆåŠŸ
- [ ] vilicode.com â†’ å¾®ä¿¡ç™»å½• â†’ æ‰«ç æˆæƒ â†’ å›è·³æˆåŠŸ
- [ ] éªŒè¯stateå‚æ•°æœ‰æ•ˆæ€§ï¼ˆ5åˆ†é’Ÿè¶…æ—¶ï¼‰
- [ ] éªŒè¯åŸŸåç™½åå•é™åˆ¶
- [ ] æµ‹è¯•ç”¨æˆ·ä¿¡æ¯è·å–å’Œå­˜å‚¨
- [ ] æµ‹è¯•JWT tokenç”Ÿæˆå’ŒéªŒè¯
- [ ] æµ‹è¯•é‡å¤ç™»å½•ï¼ˆç”¨æˆ·æ›´æ–°ï¼‰

#### Googleç™»å½•æµ‹è¯•
- [ ] code.ai80.net â†’ Googleç™»å½• â†’ æˆæƒ â†’ ç™»å½•æˆåŠŸ
- [ ] vilicode.com â†’ Googleç™»å½• â†’ æˆæƒ â†’ ç™»å½•æˆåŠŸ
- [ ] éªŒè¯ID tokenç­¾å
- [ ] æµ‹è¯•é‚®ç®±åŸŸåç™½åå•ï¼ˆå¦‚æœé…ç½®ï¼‰
- [ ] æµ‹è¯•æœªéªŒè¯é‚®ç®±æ‹’ç»
- [ ] æµ‹è¯•nonceé˜²é‡æ”¾
- [ ] æµ‹è¯•ç”¨æˆ·åˆ›å»ºå’Œæ›´æ–°

#### é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] æ— æ•ˆstateå‚æ•° â†’ è·³è½¬é”™è¯¯é¡µ
- [ ] å¾®ä¿¡æˆæƒè¢«æ‹’ â†’ è·³è½¬é”™è¯¯é¡µ
- [ ] Google tokenéªŒè¯å¤±è´¥ â†’ è¿”å›é”™è¯¯
- [ ] ç½‘ç»œè¶…æ—¶å¤„ç†
- [ ] ç™»å‡ºåŠŸèƒ½æ­£å¸¸

**Status**: Not Started

---

## ğŸ“¦ Stage 2: è·¨åŸŸæ”¯ä»˜ç³»ç»Ÿ

### 2.1 æ”¯ä»˜ç½‘å…³æ¶æ„

#### ğŸ¯ è®¾è®¡ç›®æ ‡

ä½¿ç”¨ **code.ai80.vip** ä½œä¸ºç»Ÿä¸€æ”¯ä»˜ç½‘å…³ï¼Œå¤„ç†æ‰€æœ‰åŸŸåçš„æ”¯ä»˜è¯·æ±‚ï¼Œç¡®ä¿æ”¯ä»˜å®‰å…¨å’Œåˆè§„æ€§ã€‚

#### è·¨åŸŸæ”¯ä»˜å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ç”¨æˆ·åœ¨ code.ai80.net/vilicode.com ç‚¹å‡»è´­ä¹°                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: ç”Ÿæˆæ”¯ä»˜è¯·æ±‚å‚æ•°                                             â”‚
â”‚  - amount: 199 (æ”¯ä»˜é‡‘é¢)                                             â”‚
â”‚  - userId: "encrypted_user_id" (AESåŠ å¯†)                              â”‚
â”‚  - planId: "plan_basic"                                               â”‚
â”‚  - returnUrl: "https://code.ai80.net"                                â”‚
â”‚  - signature: HMAC-SHA256(params, PAYMENT_SESSION_SECRET)            â”‚
â”‚  - timestamp: 1737461234567                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: è·³è½¬åˆ°æ”¯ä»˜ç½‘å…³                                               â”‚
â”‚  https://code.ai80.vip/payment?params...&signature=xxx                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: code.ai80.vip éªŒè¯ç­¾åå’Œå‚æ•°                                 â”‚
â”‚  - éªŒè¯ç­¾åæœ‰æ•ˆæ€§ï¼ˆHMAC-SHA256ï¼‰                                      â”‚
â”‚  - æ£€æŸ¥timestampï¼ˆ15åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰                                      â”‚
â”‚  - éªŒè¯returnUrlåœ¨ç™½åå•ä¸­                                             â”‚
â”‚  - è§£å¯†userId                                                         â”‚
â”‚  - åˆ›å»ºæ”¯ä»˜ä¼šè¯ï¼ˆ15åˆ†é’ŸTTLï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ˜¾ç¤ºæ”¯ä»˜é¡µé¢                                                 â”‚
â”‚  - é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰                                         â”‚
â”‚  - æ˜¾ç¤ºæ”¯ä»˜é‡‘é¢å’Œè®¢å•ä¿¡æ¯                                              â”‚
â”‚  - æ˜¾ç¤ºå®‰å…¨æç¤º                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ–¹å¼å¹¶å®Œæˆæ”¯ä»˜                                    â”‚
â”‚  - æ”¯ä»˜å®: æ‰«ç æˆ–è·³è½¬                                                 â”‚
â”‚  - å¾®ä¿¡æ”¯ä»˜: æ‰«ç                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 7: æ”¯ä»˜æä¾›å•†å›è°ƒ                                               â”‚
â”‚  POST https://code.ai80.vip/payment/notify                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 8: éªŒè¯æ”¯ä»˜ç»“æœå¹¶æ›´æ–°æ•°æ®                                        â”‚
â”‚  - éªŒè¯æ”¯ä»˜ç­¾å                                                       â”‚
â”‚  - æ›´æ–°è®¢å•çŠ¶æ€                                                       â”‚
â”‚  - æ›´æ–°ç”¨æˆ·ä½™é¢/è®¢é˜…                                                  â”‚
â”‚  - è®°å½•æ”¯ä»˜æµæ°´                                                       â”‚
â”‚  - ç”Ÿæˆå›è°ƒtoken                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 9: å›è·³åˆ°åŸåŸŸå                                                 â”‚
â”‚  https://code.ai80.net/payment/success?token=callback_token           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 10: åŸåŸŸåéªŒè¯å›è°ƒtokenå¹¶æ›´æ–°å‰ç«¯çŠ¶æ€                            â”‚
â”‚  - éªŒè¯tokenç­¾å                                                      â”‚
â”‚  - è·å–æ”¯ä»˜ç»“æœ                                                       â”‚
â”‚  - æ›´æ–°å‰ç«¯ä½™é¢/è®¢é˜…æ˜¾ç¤º                                               â”‚
â”‚  - æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸé¡µé¢                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å®‰å…¨æœºåˆ¶å®ç°

#### ğŸ” å…­é‡å®‰å…¨ä¿éšœ

1. **HMAC-SHA256ç­¾å**: é˜²æ­¢å‚æ•°ç¯¡æ”¹
2. **åŸŸåç™½åå•**: åªå…è®¸é…ç½®çš„åŸŸåå›è·³
3. **AESåŠ å¯†**: æ•æ„Ÿæ•°æ®ï¼ˆuserIdï¼‰åŠ å¯†ä¼ è¾“
4. **æ—¶é—´é™åˆ¶**: æ”¯ä»˜ä¼šè¯15åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
5. **CSRFä¿æŠ¤**: Stateå‚æ•°éªŒè¯
6. **åŒé‡éªŒè¯**: æ”¯ä»˜ç­¾å + å›è°ƒtoken

#### å®ç°ä»£ç 

**åˆ›å»ºæ–‡ä»¶**:
```bash
touch src/services/crossDomainPaymentService.js
touch src/routes/paymentGatewayRoutes.js
```

**crossDomainPaymentService.js** - è·¨åŸŸæ”¯ä»˜æœåŠ¡

```javascript
// src/services/crossDomainPaymentService.js
const crypto = require('crypto');
const redis = require('../models/redis');
const logger = require('../utils/logger');

class CrossDomainPaymentService {
  constructor() {
    this.sessionSecret = Buffer.from(process.env.PAYMENT_SESSION_SECRET, 'utf8');
    this.encryptionKey = Buffer.from(process.env.ENCRYPTION_KEY, 'utf8');
    this.allowedDomains = process.env.ALLOWED_RETURN_DOMAINS.split(',');
    this.sessionTTL = 900; // 15åˆ†é’Ÿ
  }

  /**
   * ç”Ÿæˆæ”¯ä»˜è¯·æ±‚ç­¾å
   * @param {Object} params - æ”¯ä»˜å‚æ•°
   */
  generateSignature(params) {
    // æŒ‰keyæ’åºå‚æ•°
    const sortedParams = Object.keys(params)
      .sort()
      .map(key => `${key}=${params[key]}`)
      .join('&');

    return crypto
      .createHmac('sha256', this.sessionSecret)
      .update(sortedParams)
      .digest('hex');
  }

  /**
   * éªŒè¯æ”¯ä»˜è¯·æ±‚ç­¾å
   */
  verifySignature(params, signature) {
    const { signature: _, ...paramsWithoutSignature } = params;
    const expectedSignature = this.generateSignature(paramsWithoutSignature);

    return crypto.timingSafeEqual(
      Buffer.from(signature),
      Buffer.from(expectedSignature)
    );
  }

  /**
   * åŠ å¯†ç”¨æˆ·ID
   */
  encryptUserId(userId) {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv('aes-256-cbc', this.encryptionKey, iv);

    let encrypted = cipher.update(userId, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    return iv.toString('hex') + ':' + encrypted;
  }

  /**
   * è§£å¯†ç”¨æˆ·ID
   */
  decryptUserId(encryptedData) {
    const parts = encryptedData.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const encrypted = parts[1];

    const decipher = crypto.createDecipheriv('aes-256-cbc', this.encryptionKey, iv);

    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');

    return decrypted;
  }

  /**
   * éªŒè¯returnUrlåœ¨ç™½åå•ä¸­
   */
  isAllowedReturnDomain(returnUrl) {
    try {
      const url = new URL(returnUrl);
      return this.allowedDomains.some(domain => url.hostname.includes(domain));
    } catch {
      return false;
    }
  }

  /**
   * åˆ›å»ºæ”¯ä»˜ä¼šè¯
   */
  async createPaymentSession(params) {
    const { amount, userId, planId, returnUrl, timestamp } = params;

    // éªŒè¯æ—¶é—´æˆ³ï¼ˆ15åˆ†é’Ÿå†…ï¼‰
    if (Date.now() - parseInt(timestamp) > 15 * 60 * 1000) {
      throw new Error('è¯·æ±‚å·²è¿‡æœŸï¼Œè¯·é‡æ–°å‘èµ·æ”¯ä»˜');
    }

    // éªŒè¯returnUrl
    if (!this.isAllowedReturnDomain(returnUrl)) {
      throw new Error('ä¸å…è®¸çš„å›è·³åŸŸå');
    }

    // ç”Ÿæˆä¼šè¯ID
    const sessionId = crypto.randomBytes(32).toString('hex');

    // å­˜å‚¨ä¼šè¯æ•°æ®ï¼ˆ15åˆ†é’ŸTTLï¼‰
    const sessionData = {
      sessionId,
      amount: parseFloat(amount),
      userId,
      planId,
      returnUrl,
      status: 'pending',
      createdAt: Date.now()
    };

    await redis.setex(
      `payment:session:${sessionId}`,
      this.sessionTTL,
      JSON.stringify(sessionData)
    );

    logger.info('åˆ›å»ºæ”¯ä»˜ä¼šè¯', { sessionId, userId, amount });

    return sessionData;
  }

  /**
   * è·å–æ”¯ä»˜ä¼šè¯
   */
  async getPaymentSession(sessionId) {
    const data = await redis.get(`payment:session:${sessionId}`);

    if (!data) {
      return null;
    }

    return JSON.parse(data);
  }

  /**
   * æ›´æ–°æ”¯ä»˜ä¼šè¯çŠ¶æ€
   */
  async updatePaymentSession(sessionId, updates) {
    const session = await this.getPaymentSession(sessionId);

    if (!session) {
      throw new Error('æ”¯ä»˜ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
    }

    const updatedSession = {
      ...session,
      ...updates,
      updatedAt: Date.now()
    };

    await redis.setex(
      `payment:session:${sessionId}`,
      this.sessionTTL,
      JSON.stringify(updatedSession)
    );

    return updatedSession;
  }

  /**
   * ç”Ÿæˆå›è°ƒtokenï¼ˆç”¨äºè¿”å›åŸåŸŸåï¼‰
   */
  generateCallbackToken(sessionId, status, orderId) {
    const tokenData = {
      sessionId,
      status,
      orderId,
      timestamp: Date.now()
    };

    const payload = Buffer.from(JSON.stringify(tokenData)).toString('base64');

    const signature = crypto
      .createHmac('sha256', this.sessionSecret)
      .update(payload)
      .digest('hex');

    return `${payload}.${signature}`;
  }

  /**
   * éªŒè¯å›è°ƒtoken
   */
  verifyCallbackToken(token) {
    try {
      const [payload, signature] = token.split('.');

      // éªŒè¯ç­¾å
      const expectedSignature = crypto
        .createHmac('sha256', this.sessionSecret)
        .update(payload)
        .digest('hex');

      if (!crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expectedSignature))) {
        throw new Error('æ— æ•ˆçš„tokenç­¾å');
      }

      // è§£ç payload
      const tokenData = JSON.parse(Buffer.from(payload, 'base64').toString('utf8'));

      // éªŒè¯æ—¶é—´æˆ³ï¼ˆ1å°æ—¶å†…æœ‰æ•ˆï¼‰
      if (Date.now() - tokenData.timestamp > 60 * 60 * 1000) {
        throw new Error('Tokenå·²è¿‡æœŸ');
      }

      return tokenData;

    } catch (error) {
      logger.error('å›è°ƒtokenéªŒè¯å¤±è´¥', { error: error.message });
      throw error;
    }
  }

  /**
   * å¤„ç†æ”¯ä»˜æˆåŠŸ
   */
  async handlePaymentSuccess(sessionId, transactionId, rawCallback) {
    const session = await this.getPaymentSession(sessionId);

    if (!session) {
      throw new Error('æ”¯ä»˜ä¼šè¯ä¸å­˜åœ¨');
    }

    if (session.status === 'completed') {
      logger.warn('é‡å¤çš„æ”¯ä»˜å›è°ƒï¼ˆå¹‚ç­‰æ€§ä¿æŠ¤ï¼‰', { sessionId });
      return session.orderId;
    }

    // åˆ›å»ºè®¢å•è®°å½•
    const orderService = require('./orderService');
    const order = await orderService.createOrder({
      userId: session.userId,
      planId: session.planId,
      amount: session.amount,
      billingCycle: 'monthly',
      paymentMethod: 'alipay', // æ ¹æ®å®é™…æƒ…å†µ
      status: 'paid',
      transactionId,
      paidAt: new Date().toISOString()
    });

    // æ¿€æ´»è®¢é˜…æˆ–å¢åŠ ä½™é¢
    const subscriptionService = require('./subscriptionService');
    await subscriptionService.activateSubscription(
      session.userId,
      session.planId,
      'monthly',
      order.orderId
    );

    // è®°å½•æ”¯ä»˜æµæ°´
    await redis.set(`payment_transaction:${transactionId}`, JSON.stringify({
      transactionId,
      orderId: order.orderId,
      userId: session.userId,
      amount: session.amount,
      paymentMethod: 'alipay',
      status: 'success',
      createdAt: new Date().toISOString(),
      completedAt: new Date().toISOString(),
      rawCallback
    }));

    // æ›´æ–°ä¼šè¯çŠ¶æ€
    await this.updatePaymentSession(sessionId, {
      status: 'completed',
      orderId: order.orderId,
      transactionId
    });

    // æ·»åŠ åˆ°ç”¨æˆ·ä½™é¢æ—¥å¿—
    await redis.lpush(
      `user:${session.userId}:balance_log`,
      JSON.stringify({
        type: 'payment',
        amount: session.amount,
        orderId: order.orderId,
        timestamp: Date.now()
      })
    );

    logger.info('æ”¯ä»˜å¤„ç†å®Œæˆ', {
      sessionId,
      orderId: order.orderId,
      userId: session.userId
    });

    return order.orderId;
  }
}

module.exports = new CrossDomainPaymentService();
```

**paymentGatewayRoutes.js** - æ”¯ä»˜ç½‘å…³è·¯ç”±

```javascript
// src/routes/paymentGatewayRoutes.js
const express = require('express');
const router = express.Router();
const crossDomainPaymentService = require('../services/crossDomainPaymentService');
const paymentService = require('../services/paymentService');
const logger = require('../utils/logger');

/**
 * åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆä»ç”¨æˆ·åŸŸåå‘èµ·ï¼‰
 * POST /api/payment/create
 * Body: { planId, billingCycle, returnUrl }
 */
router.post('/create', async (req, res) => {
  try {
    const { planId, billingCycle = 'monthly', returnUrl } = req.body;
    const userId = req.user.userId; // ä»JWTè·å–

    // è·å–å¥—é¤ä¿¡æ¯
    const subscriptionService = require('../services/subscriptionService');
    const plan = await subscriptionService.getPlan(planId);

    const amount = billingCycle === 'monthly' ? plan.price : plan.yearPrice;

    // ç”Ÿæˆæ”¯ä»˜å‚æ•°
    const timestamp = Date.now().toString();
    const encryptedUserId = crossDomainPaymentService.encryptUserId(userId);

    const params = {
      amount: amount.toString(),
      userId: encryptedUserId,
      planId,
      returnUrl,
      timestamp
    };

    // ç”Ÿæˆç­¾å
    const signature = crossDomainPaymentService.generateSignature(params);

    // æ„å»ºæ”¯ä»˜ç½‘å…³URL
    const paymentGatewayUrl = new URL(`${process.env.PAYMENT_DOMAIN}/payment`);
    Object.keys(params).forEach(key => {
      paymentGatewayUrl.searchParams.append(key, params[key]);
    });
    paymentGatewayUrl.searchParams.append('signature', signature);

    logger.info('åˆ›å»ºæ”¯ä»˜è¯·æ±‚', { userId, planId, amount });

    res.json({
      success: true,
      paymentUrl: paymentGatewayUrl.toString()
    });

  } catch (error) {
    logger.error('åˆ›å»ºæ”¯ä»˜è¯·æ±‚å¤±è´¥', { error: error.message });
    res.status(500).json({ error: error.message });
  }
});

/**
 * æ”¯ä»˜ç½‘å…³é¡µé¢ï¼ˆä»…åœ¨ code.ai80.vip ä¸Šï¼‰
 * GET /payment?amount=xxx&userId=xxx&planId=xxx&returnUrl=xxx&timestamp=xxx&signature=xxx
 */
router.get('/', async (req, res) => {
  try {
    const { signature, ...params } = req.query;

    // éªŒè¯ç­¾å
    if (!crossDomainPaymentService.verifySignature(params, signature)) {
      throw new Error('æ— æ•ˆçš„ç­¾å');
    }

    // è§£å¯†userId
    const userId = crossDomainPaymentService.decryptUserId(params.userId);

    // åˆ›å»ºæ”¯ä»˜ä¼šè¯
    const session = await crossDomainPaymentService.createPaymentSession({
      ...params,
      userId
    });

    // æ¸²æŸ“æ”¯ä»˜é¡µé¢ï¼ˆå¯ä»¥æ˜¯é™æ€HTMLæˆ–Vueç»„ä»¶ï¼‰
    res.render('payment/checkout', {
      sessionId: session.sessionId,
      amount: session.amount,
      planId: session.planId
    });

  } catch (error) {
    logger.error('æ”¯ä»˜é¡µé¢åŠ è½½å¤±è´¥', { error: error.message });
    res.status(400).send(`æ”¯ä»˜è¯·æ±‚æ— æ•ˆ: ${error.message}`);
  }
});

/**
 * å¤„ç†æ”¯ä»˜ï¼ˆç”¨æˆ·åœ¨æ”¯ä»˜é¡µé¢é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼‰
 * POST /payment/process
 * Body: { sessionId, paymentMethod: 'alipay' | 'wechat' }
 */
router.post('/process', async (req, res) => {
  try {
    const { sessionId, paymentMethod } = req.body;

    // è·å–æ”¯ä»˜ä¼šè¯
    const session = await crossDomainPaymentService.getPaymentSession(sessionId);

    if (!session) {
      throw new Error('æ”¯ä»˜ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
    }

    // è°ƒç”¨å¯¹åº”çš„æ”¯ä»˜æœåŠ¡
    let paymentResult;

    if (paymentMethod === 'alipay') {
      paymentResult = await paymentService.createAlipayOrder(
        session.userId,
        session.planId,
        'monthly'
      );
    } else if (paymentMethod === 'wechat') {
      paymentResult = await paymentService.createWechatOrder(
        session.userId,
        session.planId,
        'monthly'
      );
    } else {
      throw new Error('ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼');
    }

    // å…³è”è®¢å•åˆ°ä¼šè¯
    await crossDomainPaymentService.updatePaymentSession(sessionId, {
      orderId: paymentResult.orderId,
      paymentMethod
    });

    res.json({
      success: true,
      ...paymentResult
    });

  } catch (error) {
    logger.error('å¤„ç†æ”¯ä»˜å¤±è´¥', { error: error.message });
    res.status(500).json({ error: error.message });
  }
});

/**
 * æ”¯ä»˜å›è°ƒï¼ˆæ”¯ä»˜æä¾›å•†å›è°ƒï¼‰
 * POST /payment/notify
 */
router.post('/notify', async (req, res) => {
  try {
    // è·å–æ”¯ä»˜æ–¹å¼ï¼ˆä»URLå‚æ•°æˆ–è¯·æ±‚ä½“ï¼‰
    const paymentMethod = req.query.method || 'alipay';

    let result;

    if (paymentMethod === 'alipay') {
      result = await paymentService.handleAlipayNotify(req.body);
    } else if (paymentMethod === 'wechat') {
      result = await paymentService.handleWechatNotify(req.body);
    }

    // æŸ¥æ‰¾å¯¹åº”çš„æ”¯ä»˜ä¼šè¯
    const orderId = req.body.out_trade_no;

    // å¤„ç†æ”¯ä»˜æˆåŠŸ
    // ï¼ˆè¿™éƒ¨åˆ†é€»è¾‘å¯èƒ½éœ€è¦æ ¹æ®å®é™…çš„orderServiceè°ƒæ•´ï¼‰

    res.send('success');

  } catch (error) {
    logger.error('æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥', { error: error.message });
    res.send('fail');
  }
});

/**
 * æ”¯ä»˜å›è°ƒé¡µé¢ï¼ˆè¿”å›åˆ°åŸåŸŸåï¼‰
 * GET /payment/callback?token=xxx
 */
router.get('/callback', async (req, res) => {
  try {
    const { token } = req.query;

    // éªŒè¯å›è°ƒtoken
    const tokenData = crossDomainPaymentService.verifyCallbackToken(token);

    // è·å–æ”¯ä»˜ä¼šè¯
    const session = await crossDomainPaymentService.getPaymentSession(tokenData.sessionId);

    if (!session) {
      throw new Error('æ”¯ä»˜ä¼šè¯ä¸å­˜åœ¨');
    }

    // å›è·³åˆ°åŸåŸŸå
    const returnUrl = new URL(session.returnUrl);
    returnUrl.searchParams.append('payment_status', tokenData.status);
    returnUrl.searchParams.append('order_id', tokenData.orderId);

    res.redirect(returnUrl.toString());

  } catch (error) {
    logger.error('æ”¯ä»˜å›è°ƒå¤±è´¥', { error: error.message });
    res.status(400).send(`æ”¯ä»˜å›è°ƒå¤±è´¥: ${error.message}`);
  }
});

/**
 * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
 * GET /payment/status/:sessionId
 */
router.get('/status/:sessionId', async (req, res) => {
  try {
    const session = await crossDomainPaymentService.getPaymentSession(req.params.sessionId);

    if (!session) {
      return res.status(404).json({ error: 'ä¼šè¯ä¸å­˜åœ¨' });
    }

    res.json({
      status: session.status,
      orderId: session.orderId
    });

  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

module.exports = router;
```

### 2.3 Redisæ•°æ®ç»“æ„å®Œå–„

```javascript
// æ”¯ä»˜ä¼šè¯ï¼ˆ15åˆ†é’ŸTTLï¼‰
payment:session:{sessionId} = {
  sessionId: "abc123...",
  amount: 199,
  userId: "user_xxx",
  planId: "plan_basic",
  returnUrl: "https://code.ai80.net/payment/success",
  status: "pending", // pending | processing | completed | failed
  orderId: "ord_xxx", // å…³è”çš„è®¢å•ID
  paymentMethod: "alipay",
  transactionId: "txn_xxx",
  createdAt: 1737461234567,
  updatedAt: 1737461434567
}

// ç”¨æˆ·ä½™é¢
user:{userId}:balance = "1000" // ä½™é¢ï¼ˆåˆ†ï¼‰

// ç”¨æˆ·ä½™é¢å˜åŠ¨æ—¥å¿—
user:{userId}:balance_log = [
  {
    type: "payment", // payment | consume | refund
    amount: 199,
    orderId: "ord_xxx",
    timestamp: 1737461234567
  },
  ...
]

// OAuth tokenå­˜å‚¨ï¼ˆåŠ å¯†ï¼‰
user:{userId}:wechat_token = "iv:encrypted_data" // AES-256-CBCåŠ å¯†
user:{userId}:google_token = "iv:encrypted_data"

// OAuth nonceï¼ˆé˜²é‡æ”¾ï¼Œ5åˆ†é’ŸTTLï¼‰
oauth_nonce:{nonce} = "1" // TTL: 300ç§’

// Tokené»‘åå•ï¼ˆç™»å‡ºï¼Œ15åˆ†é’ŸTTLï¼‰
token:blacklist:{token} = "1" // TTL: 900ç§’
```

### 2.4 ç¯å¢ƒå˜é‡å®Œæ•´é…ç½®

```env
# ==================== æœåŠ¡é…ç½® ====================
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# ==================== å®‰å…¨å¯†é’¥ ====================
JWT_SECRET=your_jwt_secret_min_32_chars_random_string
ENCRYPTION_KEY=your_encryption_key_exactly_32chars
PAYMENT_SESSION_SECRET=your_payment_session_secret_32chars

# ==================== å¾®ä¿¡ç™»å½•ï¼ˆä½¿ç”¨ä¼ä¸šåŸŸå code.ai80.vipï¼‰ ====================
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=your_wechat_app_secret_from_open_platform
WECHAT_REDIRECT_URI=https://code.ai80.vip/auth/wechat/callback

# ==================== Googleç™»å½•ï¼ˆæ”¯æŒå¤šåŸŸåï¼‰ ====================
GOOGLE_OAUTH_ENABLE=true
GOOGLE_CLIENT_ID=123456789-abcdefg.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_OAUTH_ALLOWED_DOMAINS=example.com,example.org
GOOGLE_OAUTH_NONCE_TTL=300

# ==================== è·¨åŸŸè®¤è¯é…ç½® ====================
ALLOWED_AUTH_RETURN_DOMAINS=code.ai80.net,vilicode.com
AUTH_CALLBACK_TIMEOUT=300

# ==================== æ”¯ä»˜é…ç½® ====================
# æ”¯ä»˜ç½‘å…³åŸŸå
PAYMENT_DOMAIN=https://code.ai80.vip

# å…è®¸çš„å›è·³åŸŸå
ALLOWED_RETURN_DOMAINS=code.ai80.net,vilicode.com

# æ”¯ä»˜ä¼šè¯TTLï¼ˆç§’ï¼‰
PAYMENT_SESSION_TTL=900

# æ”¯ä»˜å®é…ç½®
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY=your_alipay_private_key
ALIPAY_PUBLIC_KEY=alipay_public_key

# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_MCH_ID=your_merchant_id
WECHAT_SERIAL_NO=your_certificate_serial_no
WECHAT_APIV3_KEY=your_apiv3_key

# ==================== Redisé…ç½® ====================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password
REDIS_DB=0
REDIS_ENABLE_TLS=false

# ==================== LDAPè®¤è¯ï¼ˆå¯é€‰ï¼‰ ====================
LDAP_ENABLED=false
LDAP_URL=ldaps://ldap.example.com:636
LDAP_BIND_DN=cn=admin,dc=example,dc=com
LDAP_BIND_PASSWORD=admin_password
LDAP_SEARCH_BASE=dc=example,dc=com
LDAP_SEARCH_FILTER=(uid={{username}})
LDAP_TLS_REJECT_UNAUTHORIZED=true

# ==================== å…¶ä»–é…ç½® ====================
# ç”¨æˆ·ç®¡ç†
USER_MANAGEMENT_ENABLED=true
MAX_API_KEYS_PER_USER=5

# æ—¥å¿—
LOG_LEVEL=info

# Base URLï¼ˆç”¨äºå›è°ƒï¼‰
BASE_URL=https://code.ai80.vip
```

### 2.5 Nginxé…ç½®è¯¦è§£

#### code.ai80.neté…ç½®

```nginx
# /etc/nginx/sites-available/code.ai80.net

server {
    listen 443 ssl http2;
    server_name code.ai80.net;

    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/code.ai80.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/code.ai80.net/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # ç°ä»£SSLé…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # HSTS (å¯é€‰)
    add_header Strict-Transport-Security "max-age=63072000" always;

    # å…è®¸æ‰€æœ‰è·¯ç”±ï¼ˆä¸»æœåŠ¡åŸŸåï¼‰
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;

        # ä¼ é€’çœŸå®IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocketæ”¯æŒï¼ˆSSEéœ€è¦ï¼‰
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # æµå¼å“åº”é…ç½®
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
        proxy_no_cache $http_upgrade;
        proxy_request_buffering off;

        # è¶…æ—¶é…ç½®
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_connect_timeout 30s;
    }
}

# HTTPé‡å®šå‘åˆ°HTTPS
server {
    listen 80;
    server_name code.ai80.net;
    return 301 https://$server_name$request_uri;
}
```

#### vilicode.comé…ç½®

```nginx
# /etc/nginx/sites-available/vilicode.com

server {
    listen 443 ssl http2;
    server_name vilicode.com;

    ssl_certificate /etc/letsencrypt/live/vilicode.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vilicode.com/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;

    # å…è®¸æ‰€æœ‰è·¯ç”±ï¼ˆå›½é™…æœåŠ¡åŸŸåï¼‰
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_buffering off;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
    }
}

server {
    listen 80;
    server_name vilicode.com;
    return 301 https://$server_name$request_uri;
}
```

#### code.ai80.vipé…ç½®ï¼ˆæ”¯ä»˜ç½‘å…³+è®¤è¯ä¸­è½¬ï¼‰

```nginx
# /etc/nginx/sites-available/code.ai80.vip

server {
    listen 443 ssl http2;
    server_name code.ai80.vip;

    ssl_certificate /etc/letsencrypt/live/code.ai80.vip/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/code.ai80.vip/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;

    # åªå…è®¸è®¤è¯å’Œæ”¯ä»˜ç›¸å…³è·¯ç”±
    location ~ ^/(auth|payment) {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ä¸éœ€è¦WebSocketï¼ˆè®¤è¯å’Œæ”¯ä»˜ä½¿ç”¨æ™®é€šHTTPï¼‰
        proxy_buffering off;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_connect_timeout 10s;
    }

    # æ‹’ç»æ‰€æœ‰å…¶ä»–è¯·æ±‚
    location / {
        return 403 "Access Denied - This domain is for authentication and payment only";
    }
}

server {
    listen 80;
    server_name code.ai80.vip;
    return 301 https://$server_name$request_uri;
}
```

---

## æµ‹è¯•æ¸…å• âœ…

### è®¤è¯ç³»ç»Ÿæµ‹è¯•

#### å¾®ä¿¡ç™»å½•
- [ ] code.ai80.net â†’ å¾®ä¿¡ç™»å½• â†’ æˆåŠŸå›è·³
- [ ] vilicode.com â†’ å¾®ä¿¡ç™»å½• â†’ æˆåŠŸå›è·³ï¼ˆå¦‚æ”¯æŒï¼‰
- [ ] Stateå‚æ•°éªŒè¯ï¼ˆ5åˆ†é’Ÿè¶…æ—¶ï¼‰
- [ ] åŸŸåç™½åå•éªŒè¯
- [ ] ç”¨æˆ·åˆ›å»º/æ›´æ–°
- [ ] JWT Tokenç”Ÿæˆ
- [ ] TokenåŠ å¯†å­˜å‚¨

#### Googleç™»å½•
- [ ] code.ai80.net â†’ Googleç™»å½• â†’ æˆåŠŸ
- [ ] vilicode.com â†’ Googleç™»å½• â†’ æˆåŠŸ
- [ ] ID TokenéªŒè¯
- [ ] é‚®ç®±éªŒè¯æ£€æŸ¥
- [ ] åŸŸåç™½åå•ï¼ˆå¦‚é…ç½®ï¼‰
- [ ] Nonceé˜²é‡æ”¾
- [ ] ç”¨æˆ·åˆ›å»º/æ›´æ–°

### æ”¯ä»˜ç³»ç»Ÿæµ‹è¯•

#### è·¨åŸŸæ”¯ä»˜æµç¨‹
- [ ] code.ai80.net â†’ è´­ä¹° â†’ è·³è½¬code.ai80.vip â†’ æ”¯ä»˜ â†’ å›è·³æˆåŠŸ
- [ ] vilicode.com â†’ è´­ä¹° â†’ è·³è½¬code.ai80.vip â†’ æ”¯ä»˜ â†’ å›è·³æˆåŠŸ
- [ ] ç­¾åéªŒè¯æ­£ç¡®
- [ ] æ—¶é—´æˆ³éªŒè¯ï¼ˆ15åˆ†é’Ÿï¼‰
- [ ] åŸŸåç™½åå•éªŒè¯
- [ ] ç”¨æˆ·IDåŠ å¯†/è§£å¯†
- [ ] æ”¯ä»˜ä¼šè¯åˆ›å»º
- [ ] æ”¯ä»˜æˆåŠŸå¤„ç†
- [ ] è®¢å•åˆ›å»º
- [ ] è®¢é˜…æ¿€æ´»
- [ ] ä½™é¢æ›´æ–°
- [ ] å›è°ƒTokenéªŒè¯

#### æ”¯ä»˜æ–¹å¼æµ‹è¯•
- [ ] æ”¯ä»˜å®æ”¯ä»˜æµç¨‹
- [ ] å¾®ä¿¡æ”¯ä»˜æµç¨‹
- [ ] æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] é‡å¤å›è°ƒå¹‚ç­‰æ€§

### å®‰å…¨æµ‹è¯•

#### ç­¾åå’ŒåŠ å¯†
- [ ] HMAC-SHA256ç­¾åéªŒè¯
- [ ] ç¯¡æ”¹å‚æ•°æ£€æµ‹
- [ ] AESåŠ å¯†æ­£ç¡®æ€§
- [ ] Nonceé˜²é‡æ”¾
- [ ] Tokené»‘åå•

#### åŸŸåå®‰å…¨
- [ ] åŸŸåç™½åå•é™åˆ¶
- [ ] éæ³•åŸŸåæ‹’ç»
- [ ] HTTPSå¼ºåˆ¶

#### æ—¶é—´å®‰å…¨
- [ ] æ”¯ä»˜ä¼šè¯15åˆ†é’Ÿè¿‡æœŸ
- [ ] Stateå‚æ•°5åˆ†é’Ÿè¿‡æœŸ
- [ ] Token 1å°æ—¶è¿‡æœŸ

---

## éƒ¨ç½²æ¸…å• ğŸ“¦

### ç¯å¢ƒå˜é‡æ£€æŸ¥
- [ ] JWT_SECRETï¼ˆ32å­—ç¬¦ä»¥ä¸Šï¼‰
- [ ] ENCRYPTION_KEYï¼ˆ32å­—ç¬¦ï¼‰
- [ ] PAYMENT_SESSION_SECRETï¼ˆ32å­—ç¬¦ï¼‰
- [ ] WECHAT_APP_IDã€WECHAT_APP_SECRET
- [ ] GOOGLE_CLIENT_IDã€GOOGLE_CLIENT_SECRET
- [ ] ALIPAYé…ç½®
- [ ] ALLOWED_AUTH_RETURN_DOMAINS
- [ ] ALLOWED_RETURN_DOMAINS
- [ ] PAYMENT_DOMAIN

### åŸŸåå’ŒSSL
- [ ] code.ai80.net SSLè¯ä¹¦
- [ ] vilicode.com SSLè¯ä¹¦
- [ ] code.ai80.vip SSLè¯ä¹¦
- [ ] Nginxé…ç½®éƒ¨ç½²
- [ ] DNSè§£ææ­£ç¡®

### ç¬¬ä¸‰æ–¹æœåŠ¡
- [ ] å¾®ä¿¡å¼€æ”¾å¹³å°å®¡æ ¸é€šè¿‡
- [ ] Google OAuthé…ç½®å®Œæˆ
- [ ] æ”¯ä»˜å®å•†æˆ·é…ç½®
- [ ] å¾®ä¿¡æ”¯ä»˜å•†æˆ·é…ç½®

### ç›‘æ§å’Œæ—¥å¿—
- [ ] è®¤è¯æ—¥å¿—è®°å½•
- [ ] æ”¯ä»˜æ—¥å¿—è®°å½•
- [ ] é”™è¯¯ç›‘æ§
- [ ] æ€§èƒ½ç›‘æ§

---

## å¼€å‘æ—¶é—´ä¼°ç®— â±ï¸

- **Stage 1ï¼ˆå¤šåŸŸåè®¤è¯ï¼‰**: 6-8å¤©
  - å¾®ä¿¡ç™»å½•è·¨åŸŸå®ç°ï¼š3-4å¤©
  - Googleç™»å½•GISå®ç°ï¼š2-3å¤©
  - å‰ç«¯é›†æˆå’Œæµ‹è¯•ï¼š1-2å¤©

- **Stage 2ï¼ˆè·¨åŸŸæ”¯ä»˜ï¼‰**: 5-7å¤©
  - æ”¯ä»˜ç½‘å…³å®ç°ï¼š3-4å¤©
  - å®‰å…¨æœºåˆ¶å®ç°ï¼š1-2å¤©
  - å‰ç«¯é›†æˆå’Œæµ‹è¯•ï¼š1-2å¤©

**æ€»è®¡**: çº¦11-15ä¸ªå·¥ä½œæ—¥

---

## æˆåŠŸæŒ‡æ ‡ ğŸ“Š

### æŠ€æœ¯æŒ‡æ ‡
- è®¤è¯æˆåŠŸç‡ > 95%
- æ”¯ä»˜æˆåŠŸç‡ > 98%
- è·¨åŸŸè·³è½¬æ—¶é—´ < 2ç§’
- APIå“åº”æ—¶é—´ < 500ms
- ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%

### å®‰å…¨æŒ‡æ ‡
- é›¶ç­¾åä¼ªé€ äº‹ä»¶
- é›¶å‚æ•°ç¯¡æ”¹äº‹ä»¶
- é›¶éæ³•åŸŸåå›è·³
- æ‰€æœ‰æ•æ„Ÿæ•°æ®åŠ å¯†

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
- è®¤è¯æµç¨‹å®Œæˆç‡ > 90%
- æ”¯ä»˜æµç¨‹å®Œæˆç‡ > 85%
- ç”¨æˆ·æŠ•è¯‰ç‡ < 1%

---

æ–‡æ¡£ç‰ˆæœ¬: 2.0
æœ€åæ›´æ–°: 2025-01-21
ç»´æŠ¤è€…: Coding Bus Team
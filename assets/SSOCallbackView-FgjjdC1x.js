import{r as l,q as U,aX as B,V as E,x as o,z as s,R as h,aW as I,L as w,P as d,Q as $,ac as D,J as L,av as W,u as q,y as n,C as j,O as P}from"./vue-vendor-K9KD2h4K.js";import{_ as F,c as J,b as Q,s as A}from"./index-CKZDKUL7.js";import{T as X}from"./ThemeToggle-CZyvTJ1n.js";import"./vendor-DITxge4O.js";import"./element-plus-D5qhxq3g.js";const G={class:"relative flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 dark:bg-gray-900 sm:px-6 lg:px-8"},H={class:"fixed right-4 top-4 z-10"},K={class:"w-full max-w-md space-y-8"},Y={class:"rounded-lg bg-white px-6 py-8 shadow dark:bg-gray-800 dark:shadow-xl"},Z={key:0,class:"space-y-6 text-center"},ee={class:"space-y-2"},se={class:"text-xl font-semibold text-gray-900 dark:text-white"},te={class:"space-y-2"},re={class:"flex justify-center space-x-2"},ae={class:"text-xs text-gray-500 dark:text-gray-500"},le={key:1,class:"space-y-6 text-center"},oe={class:"space-y-2"},ne={class:"text-sm text-gray-600 dark:text-gray-400"},ie={key:2,class:"space-y-6 text-center"},ue={class:"space-y-2"},de={class:"text-sm text-gray-600 dark:text-gray-400"},ce={class:"space-y-3"},ge=["disabled"],fe={class:"flex space-x-2"},ve={key:0,class:"mt-4 rounded-lg bg-gray-100 p-4 dark:bg-gray-800"},me={class:"mt-2 overflow-auto text-xs text-gray-600 dark:text-gray-400"},k=3,xe={__name:"SSOCallbackView",setup(be){const _=B(),c=J(),R=Q(),r=l("processing"),S=l("正在处理您的登录..."),a=l(""),g=l(null),i=l(0),u=l(0),V=!1,C=l(null),v=["验证OAuth回调","获取用户信息","同步到后端","完成登录"];let m=null,x=null;function b(t,e){u.value=t,S.value=e}async function O(){try{if(console.log("SSOCallback: 开始处理OAuth回调"),b(0,"正在验证OAuth回调..."),!c.isClerkReady)throw new Error("Clerk 系统尚未初始化完成");if(await new Promise(e=>setTimeout(e,1e3)),b(1,"正在获取用户信息..."),!await c.handleOAuthCallback())throw new Error("OAuth回调处理失败");if(await new Promise(e=>setTimeout(e,800)),b(2,"正在同步用户数据到后端..."),!c.currentUser)throw new Error("无法获取用户信息");g.value=c.currentUser,await c.syncWithUserStore(),await new Promise(e=>setTimeout(e,800)),b(3,"正在完成登录..."),await new Promise(e=>setTimeout(e,500)),r.value="success",console.log("SSOCallback: OAuth回调处理成功"),A(`欢迎回来，${g.value.fullName||g.value.email}！`,"success"),x=setTimeout(()=>{_.replace("/user-dashboard")},2e3)}catch(t){console.error("SSOCallback: OAuth回调处理失败",t),r.value="error",t.message.includes("取消")||t.message.includes("cancelled")?a.value="用户取消了登录授权":t.message.includes("网络")||t.message.includes("timeout")?a.value="网络连接超时，请检查网络后重试":t.message.includes("初始化")||t.message.includes("准备")?a.value="社交登录系统初始化失败，请稍后重试":t.message.includes("同步")?a.value="用户数据同步失败，请重试或联系管理员":a.value=t.message||"登录处理过程中发生未知错误",A("登录失败："+a.value,"error")}}async function z(){i.value>=k||(i.value++,r.value="processing",u.value=0,a.value="",console.log(`SSOCallback: 第 ${i.value} 次重试登录`),await O())}function M(){m=setInterval(()=>{r.value==="processing"&&u.value<v.length-1},1e3)}function N(){m&&(clearInterval(m),m=null),x&&(clearTimeout(x),x=null)}return U(async()=>{console.log("SSOCallback: 页面挂载");const t=new URLSearchParams(window.location.search),e=t.get("error"),f=t.get("error_description");if(e){console.error("SSOCallback: URL中包含错误参数",{urlError:e,errorDescription:f}),r.value="error",a.value=f||`OAuth错误: ${e}`;return}if(R.isAuthenticated){console.log("SSOCallback: 用户已登录，重定向到仪表板"),_.replace("/user-dashboard");return}M(),await new Promise(p=>setTimeout(p,500)),await O()}),E(()=>{N()}),window.addEventListener("beforeunload",t=>{r.value==="processing"&&(t.preventDefault(),t.returnValue="登录正在处理中，确定要离开吗？")}),(t,e)=>{var p,T;const f=W("RouterLink");return n(),o("div",G,[s("div",H,[h(X,{mode:"dropdown"})]),s("div",K,[e[11]||(e[11]=I('<div class="text-center" data-v-53c1c792><div class="mx-auto flex h-12 w-auto items-center justify-center" data-v-53c1c792><svg class="h-8 w-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-53c1c792><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" data-v-53c1c792></path></svg><span class="ml-2 text-xl font-bold text-gray-900 dark:text-white" data-v-53c1c792>Claude Relay</span></div></div>',1)),s("div",Y,[r.value==="processing"?(n(),o("div",Z,[e[1]||(e[1]=s("div",{class:"flex items-center justify-center"},[s("div",{class:"relative h-16 w-16 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"},[s("div",{class:"absolute inset-2 animate-pulse rounded-full bg-blue-500/20 dark:bg-blue-400/20"})])],-1)),s("div",ee,[s("h2",se,d(S.value),1),e[0]||(e[0]=s("p",{class:"text-sm text-gray-600 dark:text-gray-400"}," 请稍候，我们正在安全地处理您的登录信息... ",-1))]),s("div",te,[s("div",re,[(n(),o($,null,D(v,(pe,y)=>s("div",{key:y,class:"flex items-center space-x-2"},[s("div",{class:j(["h-2 w-2 rounded-full transition-colors duration-300",y<=u.value?"bg-blue-500 dark:bg-blue-400":"bg-gray-300 dark:bg-gray-600"])},null,2),y<v.length-1?(n(),o("span",{key:0,class:j(["h-px w-8 transition-colors duration-300",y<u.value?"bg-blue-500 dark:bg-blue-400":"bg-gray-300 dark:bg-gray-600"])},null,2)):w("",!0)])),64))]),s("p",ae,d(v[u.value]),1)])])):r.value==="success"?(n(),o("div",le,[e[4]||(e[4]=s("div",{class:"flex items-center justify-center"},[s("div",{class:"flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/20"},[s("svg",{class:"h-8 w-8 text-green-600 dark:text-green-400",fill:"currentColor",viewBox:"0 0 20 20"},[s("path",{"clip-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","fill-rule":"evenodd"})])])],-1)),s("div",oe,[e[2]||(e[2]=s("h2",{class:"text-xl font-semibold text-green-600 dark:text-green-400"},"登录成功！",-1)),s("p",ne," 欢迎回来，"+d(((p=g.value)==null?void 0:p.fullName)||((T=g.value)==null?void 0:T.email)),1),e[3]||(e[3]=s("p",{class:"text-xs text-gray-500 dark:text-gray-500"},"正在跳转到您的仪表板...",-1))]),e[5]||(e[5]=s("div",{class:"flex justify-center"},[s("div",{class:"h-1 w-32 overflow-hidden rounded bg-gray-200 dark:bg-gray-700"},[s("div",{class:"h-full w-full origin-left animate-pulse bg-blue-500 dark:bg-blue-400"})])],-1))])):r.value==="error"?(n(),o("div",ie,[e[9]||(e[9]=s("div",{class:"flex items-center justify-center"},[s("div",{class:"flex h-16 w-16 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/20"},[s("svg",{class:"h-8 w-8 text-red-600 dark:text-red-400",fill:"currentColor",viewBox:"0 0 20 20"},[s("path",{"clip-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","fill-rule":"evenodd"})])])],-1)),s("div",ue,[e[6]||(e[6]=s("h2",{class:"text-xl font-semibold text-red-600 dark:text-red-400"},"登录失败",-1)),s("p",de,d(a.value),1)]),s("div",ce,[s("button",{class:"w-full rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400",disabled:i.value>=k,onClick:z},d(i.value>=k?"重试次数已达上限":`重试登录 (${i.value}/${k})`),9,ge),s("div",fe,[h(f,{class:"flex-1 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700",to:"/user-login-social"},{default:L(()=>e[7]||(e[7]=[P(" 重新选择登录方式 ",-1)])),_:1,__:[7]}),h(f,{class:"flex-1 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700",to:"/user-login"},{default:L(()=>e[8]||(e[8]=[P(" 传统登录 ",-1)])),_:1,__:[8]})])])])):w("",!0)]),q(V)&&C.value?(n(),o("div",ve,[s("details",null,[e[10]||(e[10]=s("summary",{class:"cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-300"}," 调试信息 (开发环境) ",-1)),s("pre",me,d(C.value),1)])])):w("",!0)])])}}},Se=F(xe,[["__scopeId","data-v-53c1c792"]]);export{Se as default};
